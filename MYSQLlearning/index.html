
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>MYSQLlearning - YuStone</title>

  
    <meta name="description" content="MySQL学习">
<meta property="og:type" content="article">
<meta property="og:title" content="MYSQLlearning">
<meta property="og:url" content="http://yustonerain.top/MYSQLlearning/">
<meta property="og:site_name" content="YuStone">
<meta property="og:description" content="MySQL学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yustonerain.top/images/avatar.jpg">
<meta property="article:published_time" content="2025-07-25T07:46:07.000Z">
<meta property="article:modified_time" content="2025-08-03T13:26:16.000Z">
<meta property="article:author" content="YuStone">
<meta property="article:tag" content="MYSQL learning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yustonerain.top/images/avatar.jpg">
  
  
  
  <meta name="keywords" content="MYSQL learning">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="YuStone" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  
    <link rel="shortcut icon" href="/favicon1.ico">
  

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"YuStone","sameAs":[],"image":"/images/avatar.jpg"},"dateCreated":"2025-07-25T15:46:07+08:00","dateModified":"2025-08-03T21:26:16+08:00","datePublished":"2025-07-25T15:46:07+08:00","description":"MySQL学习","headline":"MYSQLlearning","mainEntityOfPage":{"@type":"WebPage","@id":"http://yustonerain.top/MYSQLlearning/"},"publisher":{"@type":"Organization","name":"YuStone","sameAs":[],"image":"/images/avatar.jpg","logo":{"@type":"ImageObject","url":"/images/avatar.jpg"}},"url":"http://yustonerain.top/MYSQLlearning/","keywords":"MYSQL learning","image":[]}</script>
  
</head>
<body>

<div class="l_body content" id="start" layout="post" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/images/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main">YuStone</div><div class="sub normal cap">我的独立博客</div><div class="sub hover cap" style="opacity:0"> 欢迎来到我的博客</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="朋友" href="/friends/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>



<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/protobuf%E5%AE%9E%E8%B7%B5cpp/"><span class="title">protobuf实践基于cpp</span></a><a class="item title" href="/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E6%A1%86%E6%9E%B6/"><span class="title">分布式网络通信框架编写</span></a><a class="item title" href="/%E5%89%96%E6%9E%90muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81/"><span class="title">剖析muduo网络库核心代码</span></a><a class="item title" href="/mysql%E8%BF%9E%E6%8E%A5%E6%B1%A0/"><span class="title">mysql连接池</span></a><a class="item title" href="/C-%E6%8F%90%E5%8D%87/"><span class="title">C++提升</span></a><a class="item title" href="/C-basiclearning/"><span class="title">C++basiclearning</span></a><a class="item title" href="/git%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/"><span class="title">git必知必会</span></a><a class="item title" href="/MYSQLlearning/"><span class="title">MYSQLlearning</span></a><a class="item title" href="/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><span class="title">Linux网络编程</span></a><a class="item title" href="/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/"><span class="title">Linux系统编程</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/YuStone0416" target="_blank" rel="external nofollow noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder/social/08a41b181ce68.svg"/></a><a class="social" href="https://" target="_blank" rel="external nofollow noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder/social/3845874.svg"/></a><a class="social" href="https://" target="_blank" rel="external nofollow noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder/social/3616429.svg"/></a><a class="social" href="https://" target="_blank" rel="external nofollow noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder/social/942ebbf1a4b91.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/MYSQL-learning/">MYSQL learning</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2025-07-25T07:46:07.000Z">2025-07-25</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2025-08-03T13:26:16.000Z">2025-08-03</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>MYSQLlearning</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h2 id="MySQL基础"><a href="#MySQL基础" class="headerlink" title="MySQL基础"></a>MySQL基础</h2><h3 id="MySQL介绍"><a href="#MySQL介绍" class="headerlink" title="MySQL介绍"></a>MySQL介绍</h3><ol>
<li>关系型数据库(<strong>有行有列</strong>) <strong>SQLite(进程内的db)</strong>  NOSQL(<strong>非关系数据库)键值对</strong>（key-value）:redis leveldb rocksdb 大数据分析列式数据库 Hbase</li>
<li>大家熟悉的关系型数据库还有SQL Server,Oracle,MySQL,MariaDB,DB2</li>
<li>MySQL区别于其他关系型数据库最大的一个特点就是<strong>支持插件式的存储引擎</strong>，支持如<strong>InnoDB,MyISAM,Memory</strong>等</li>
<li>MySQL设计成<strong>C&#x2F;S模型</strong></li>
<li>MySQL的服务器模型采用的是<strong>I&#x2F;O复用+可伸缩的线程池</strong>，是实现网络服务器的经典模型。用的是<strong>select+线程池。</strong>这里为什么不设计成epoll+线程池，或者更高效的模型，<strong>用select,因为网络I&#x2F;O快，但是MySQL还需要把数据存储到磁盘，磁盘I&#x2F;O速度是比较慢的，所以速度匹配即可，没必要做那么快</strong>。</li>
</ol>
<p><img src="/MYSQLlearning/1.png" alt="1"></p>
<p><strong>Windows下MySQL安装目录中有一个my.ini文件，可以做一些配置调优。在data文件夹中，每建立一个数据库会有一个文件夹与其对应。</strong></p>
<p><strong>Linux下mysql的配置文件 &#x2F;etc&#x2F;my.cnf，没有可以自己创建</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在root用户下</span></span><br><span class="line">netstat -tanp <span class="comment">#查看mysql是否启动,这个命令主要显示当前系统的所有 TCP 连接及其状态，并显示对应的进程信息。</span></span><br><span class="line">service mysql start <span class="comment">#启动mysql</span></span><br></pre></td></tr></table></figure>

<h3 id="MySQL数据类型"><a href="#MySQL数据类型" class="headerlink" title="MySQL数据类型"></a>MySQL数据类型</h3><p><strong>MySQL数据类型定义了数据的大小范围，因此使用时选择合适的类型，不仅会降低表占用的磁盘空间，间接减少了磁盘I&#x2F;O的次数，提高了表的访问效率，而且索引的效率也和数据的类型息息相关。</strong></p>
<h4 id="整数类型（Integer-Types）"><a href="#整数类型（Integer-Types）" class="headerlink" title="整数类型（Integer Types）"></a><strong>整数类型（Integer Types）</strong></h4><table>
<thead>
<tr>
<th>类型</th>
<th>大小（字节）</th>
<th>范围（有符号）</th>
<th>范围（无符号）</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>TINYINT</code></td>
<td>1</td>
<td>-128 到 127</td>
<td>0 到 255</td>
<td>很小的整数</td>
</tr>
<tr>
<td><code>SMALLINT</code></td>
<td>2</td>
<td>-32,768 到 32,767</td>
<td>0 到 65,535</td>
<td>小整数</td>
</tr>
<tr>
<td><code>MEDIUMINT</code></td>
<td>3</td>
<td>-8,388,608 到 8,388,607</td>
<td>0 到 16,777,215</td>
<td>中等大小的整数</td>
</tr>
<tr>
<td><code>INT</code> 或 <code>INTEGER</code></td>
<td>4</td>
<td>-2,147,483,648 到 2,147,483,647</td>
<td>0 到 4,294,967,295</td>
<td>常用整数类型</td>
</tr>
<tr>
<td><code>BIGINT</code></td>
<td>8</td>
<td>-9,223,372,036,854,775,808 到 9,223,372,036,854,775,807</td>
<td>0 到 18,446,744,073,709,551,615</td>
<td>大整数</td>
</tr>
</tbody></table>
<p>可加上 <code>UNSIGNED</code> 修饰符来存储更大的非负整数</p>
<p>age INT(9)：整型占用内存的大小是固定的，和具体的类型是强相关的。(M)只是代表整数显示的宽度</p>
<h4 id="浮点与定点类型（Floating-Point-and-Fixed-Point-Types）"><a href="#浮点与定点类型（Floating-Point-and-Fixed-Point-Types）" class="headerlink" title="浮点与定点类型（Floating-Point and Fixed-Point Types）"></a><strong>浮点与定点类型（Floating-Point and Fixed-Point Types）</strong></h4><p><strong>推荐DECIMAL,FLOAT和DOUBLE数据越界不会报错，DECIMAL会报错</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
<th>范围和精度</th>
</tr>
</thead>
<tbody><tr>
<td><code>FLOAT(M,D)</code></td>
<td>单精度浮点数</td>
<td>近似值，4字节，M是总位数，D是小数位数 7位精度</td>
</tr>
<tr>
<td><code>DOUBLE(M,D)</code> 或 <code>REAL(M,D)</code></td>
<td>双精度浮点数</td>
<td>近似值，8字节，M是总位数，D是小数位数  15位精度</td>
</tr>
<tr>
<td><code>DECIMAL(M,D)</code> 或 <code>NUMERIC(M,D)</code></td>
<td>定点数</td>
<td>精确值，适合存储货币等对精度要求高的场景</td>
</tr>
</tbody></table>
<ul>
<li><code>M</code>: 精度（总位数），<code>D</code>: 小数位数</li>
<li><code>DECIMAL</code> 使用字符串进行存储，防止浮点误差</li>
<li>如果 <code>M</code> 和 <code>D</code> 不指定，MySQL 默认为 <code>DECIMAL(10,0)</code></li>
</ul>
<h4 id="字符型类型"><a href="#字符型类型" class="headerlink" title="字符型类型"></a><strong>字符型类型</strong></h4><table>
<thead>
<tr>
<th>类型</th>
<th>最大长度</th>
<th>是否定长</th>
<th>是否可设默认值</th>
<th>特点说明</th>
<th>典型用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>CHAR(M)</code></td>
<td>最多 255 字符</td>
<td>✅</td>
<td>✅</td>
<td>固定长度，右侧自动补空格</td>
<td>固定长度：手机号、身份证</td>
</tr>
<tr>
<td><code>VARCHAR(M)</code></td>
<td>取决于字符集（如 utf8mb4 最多 21844）</td>
<td>❌</td>
<td>✅</td>
<td>变长字符串，节省空间，需额外1-2字节</td>
<td>姓名、标题、备注</td>
</tr>
<tr>
<td><code>TINYTEXT</code></td>
<td>255 字节</td>
<td>❌</td>
<td>❌</td>
<td>极短文本，不能设默认值</td>
<td>简短评论、小段文字</td>
</tr>
<tr>
<td><code>TEXT</code></td>
<td>64 KB</td>
<td>❌</td>
<td>❌</td>
<td>常用文本类型，不能设默认值</td>
<td>文章正文、用户简介</td>
</tr>
<tr>
<td><code>MEDIUMTEXT</code></td>
<td>16 MB</td>
<td>❌</td>
<td>❌</td>
<td>中大型文本</td>
<td>博文、报告内容</td>
</tr>
<tr>
<td><code>LONGTEXT</code></td>
<td>4 GB</td>
<td>❌</td>
<td>❌</td>
<td>超大文本</td>
<td>大文档、日志</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>类型</th>
<th>最大长度</th>
<th>特点说明</th>
<th>用途举例</th>
</tr>
</thead>
<tbody><tr>
<td><code>BINARY(M)</code></td>
<td>最多 255 字节</td>
<td>类似 <code>CHAR</code>，存储二进制数据，定长</td>
<td>加密哈希、固定密钥存储</td>
</tr>
<tr>
<td><code>VARBINARY(M)</code></td>
<td>最多 65535 字节</td>
<td>类似 <code>VARCHAR</code>，变长二进制字符串</td>
<td>二进制令牌、签名</td>
</tr>
<tr>
<td><code>TINYBLOB</code></td>
<td>255 字节</td>
<td>与 <code>TINYTEXT</code> 类似，但用于二进制数据</td>
<td>小图标、缩略图</td>
</tr>
<tr>
<td><code>BLOB</code></td>
<td>64 KB</td>
<td>与 <code>TEXT</code> 类似，用于二进制内容</td>
<td>图像、音频、文件</td>
</tr>
<tr>
<td><code>MEDIUMBLOB</code></td>
<td>16 MB</td>
<td>中等大小二进制对象</td>
<td>视频、音频中等资源</td>
</tr>
<tr>
<td><code>LONGBLOB</code></td>
<td>4 GB</td>
<td>超大二进制对象</td>
<td>文件存储、大附件</td>
</tr>
</tbody></table>
<h4 id="日期和时间类型"><a href="#日期和时间类型" class="headerlink" title="日期和时间类型"></a><strong>日期和时间类型</strong></h4><table>
<thead>
<tr>
<th>类型</th>
<th>占用空间</th>
<th>范围&#x2F;格式</th>
<th>精度</th>
<th>用途示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>DATE</code></td>
<td>3 字节</td>
<td><code>1000-01-01</code> 到 <code>9999-12-31</code></td>
<td>到“日”</td>
<td>出生日期、订单日期</td>
</tr>
<tr>
<td><code>TIME</code></td>
<td>3 字节</td>
<td><code>-838:59:59</code> 到 <code>838:59:59</code></td>
<td>到“秒”</td>
<td>持续时间、工时</td>
</tr>
<tr>
<td><code>DATETIME</code></td>
<td>8 字节</td>
<td><code>1000-01-01 00:00:00</code> 到 <code>9999-12-31 23:59:59</code></td>
<td>到“秒”</td>
<td>记录某一精确时刻</td>
</tr>
<tr>
<td><code>TIMESTAMP</code></td>
<td>4 字节</td>
<td><code>1970-01-01 00:00:01</code> UTC 到 <code>2038-01-19 03:14:07</code></td>
<td>到“秒”</td>
<td>创建时间、修改时间</td>
</tr>
<tr>
<td><code>YEAR</code></td>
<td>1 字节</td>
<td><code>1901</code> 到 <code>2155</code></td>
<td>到“年”</td>
<td>出厂年份、学年</td>
</tr>
</tbody></table>
<h4 id="枚举与集合类型（可存储预定义字符串）"><a href="#枚举与集合类型（可存储预定义字符串）" class="headerlink" title="枚举与集合类型（可存储预定义字符串）"></a>枚举与集合类型（可存储预定义字符串）</h4><table>
<thead>
<tr>
<th>类型</th>
<th>特点说明</th>
<th>示例用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>ENUM(...)</code></td>
<td>从固定字符串列表中选一个值，实际存储为整数索引（1字节）</td>
<td>性别、状态（如 <code>&#39;男&#39;,&#39;女&#39;</code>、<code>&#39;启用&#39;,&#39;禁用&#39;</code>）</td>
</tr>
<tr>
<td><code>SET(...)</code></td>
<td>可多选，存储为位图（1~8字节），最多支持 64 个选项</td>
<td>标签、用户权限、兴趣爱好</td>
</tr>
</tbody></table>
<h3 id="MySQL运算符"><a href="#MySQL运算符" class="headerlink" title="MySQL运算符"></a>MySQL运算符</h3><h4 id="算数运算符"><a href="#算数运算符" class="headerlink" title="算数运算符"></a>算数运算符</h4><table>
<thead>
<tr>
<th>运算符</th>
<th>含义</th>
<th>示例</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td><code>+</code></td>
<td>加法</td>
<td><code>5 + 3</code></td>
<td><code>8</code></td>
</tr>
<tr>
<td><code>-</code></td>
<td>减法</td>
<td><code>5 - 3</code></td>
<td><code>2</code></td>
</tr>
<tr>
<td><code>*</code></td>
<td>乘法</td>
<td><code>5 * 3</code></td>
<td><code>15</code></td>
</tr>
<tr>
<td><code>/</code></td>
<td>除法</td>
<td><code>5 / 2</code></td>
<td><code>2.5</code></td>
</tr>
<tr>
<td><code>DIV</code></td>
<td>整除</td>
<td><code>5 DIV 2</code></td>
<td><code>2</code></td>
</tr>
<tr>
<td><code>%</code></td>
<td>取模（余数）</td>
<td><code>5 % 2</code> 或 <code>5 MOD 2</code></td>
<td><code>1</code></td>
</tr>
<tr>
<td><code>MOD</code></td>
<td>同 <code>%</code></td>
<td><code>5 MOD 3</code></td>
<td><code>2</code></td>
</tr>
</tbody></table>
<h4 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h4><table>
<thead>
<tr>
<th>运算符</th>
<th>名称</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>AND</code></td>
<td>逻辑与</td>
<td><code>age &gt; 18 AND gender = &#39;M&#39;</code></td>
<td>两个条件都为真，结果才为真</td>
</tr>
<tr>
<td><code>OR</code></td>
<td>逻辑或</td>
<td><code>score &gt; 90 OR grade = &#39;A&#39;</code></td>
<td>至少一个条件为真，结果为真</td>
</tr>
<tr>
<td><code>NOT</code></td>
<td>逻辑非</td>
<td><code>NOT (age &lt; 18)</code></td>
<td>取反，原来为真变为假，反之亦然</td>
</tr>
<tr>
<td><code>XOR</code></td>
<td>逻辑异或</td>
<td><code>TRUE XOR FALSE</code></td>
<td>仅当两个值不同，结果才为真</td>
</tr>
<tr>
<td><code>!</code></td>
<td>逻辑非（简写）</td>
<td><code>!is_deleted</code></td>
<td>等价于 <code>NOT is_deleted</code></td>
</tr>
<tr>
<td><code>&amp;&amp;</code></td>
<td>与（MySQL兼容）</td>
<td><code>a &gt; 5 &amp;&amp; b &lt; 10</code></td>
<td>等价于 <code>AND</code></td>
</tr>
<tr>
<td>&#96;</td>
<td></td>
<td>&#96;</td>
<td>逻辑或</td>
</tr>
</tbody></table>
<h4 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h4><table>
<thead>
<tr>
<th>运算符</th>
<th>含义</th>
<th>示例</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td><code>=</code></td>
<td>等于</td>
<td><code>age = 18</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>!=</code> 或 <code>&lt;&gt;</code></td>
<td>不等于</td>
<td><code>name != &#39;Tom&#39;</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>大于</td>
<td><code>score &gt; 60</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>小于</td>
<td><code>score &lt; 60</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>&gt;=</code></td>
<td>大于等于</td>
<td><code>score &gt;= 90</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>&lt;=</code></td>
<td>小于等于</td>
<td><code>score &lt;= 100</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>&lt;=&gt;</code></td>
<td>安全等于（支持 NULL）</td>
<td><code>a &lt;=&gt; NULL</code></td>
<td><code>true</code> if both NULL</td>
</tr>
<tr>
<td><code>IS NULL</code></td>
<td>判断是否为 NULL</td>
<td><code>birthday IS NULL</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>IS NOT NULL</code></td>
<td>非 NULL</td>
<td><code>email IS NOT NULL</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>BETWEEN ... AND ...</code></td>
<td>在区间内</td>
<td><code>score BETWEEN 60 AND 90</code></td>
<td>含头尾：<code>60 ≤ score ≤ 90</code></td>
</tr>
<tr>
<td><code>NOT BETWEEN ... AND ...</code></td>
<td>不在区间</td>
<td><code>age NOT BETWEEN 18 AND 25</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>IN (...)</code></td>
<td>属于集合</td>
<td><code>city IN (&#39;Beijing&#39;, &#39;Shanghai&#39;)</code></td>
<td>是否存在于集合中</td>
</tr>
<tr>
<td><code>NOT IN (...)</code></td>
<td>不属于集合</td>
<td><code>status NOT IN (&#39;A&#39;, &#39;B&#39;)</code></td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>LIKE</code></td>
<td>模糊匹配（单行）</td>
<td><code>name LIKE &#39;J%&#39;</code></td>
<td><code>J</code>开头的字符串</td>
</tr>
<tr>
<td><code>NOT LIKE</code></td>
<td>非匹配</td>
<td><code>email NOT LIKE &#39;%.com&#39;</code></td>
<td>不以<code>.com</code>结尾</td>
</tr>
<tr>
<td><code>REGEXP</code> 或 <code>RLIKE</code></td>
<td>正则匹配</td>
<td><code>name REGEXP &#39;^A.*&#39;</code></td>
<td>匹配正则表达式</td>
</tr>
</tbody></table>
<h3 id="MySQL常用函数"><a href="#MySQL常用函数" class="headerlink" title="MySQL常用函数"></a>MySQL常用函数</h3><table>
<thead>
<tr>
<th>分类</th>
<th>函数名</th>
<th>功能描述</th>
<th>示例</th>
<th>示例结果</th>
</tr>
</thead>
<tbody><tr>
<td>字符串函数</td>
<td><code>CONCAT(str1, str2, ...)</code></td>
<td>字符串连接</td>
<td><code>CONCAT(&#39;Hello&#39;, &#39;World&#39;)</code></td>
<td><code>&#39;HelloWorld&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>LENGTH(str)</code></td>
<td>字节长度（utf8中一个汉字3字节）</td>
<td><code>LENGTH(&#39;abc&#39;)</code></td>
<td><code>3</code></td>
</tr>
<tr>
<td></td>
<td><code>CHAR_LENGTH(str)</code></td>
<td>字符长度（汉字算1个字符）</td>
<td><code>CHAR_LENGTH(&#39;你好&#39;)</code></td>
<td><code>2</code></td>
</tr>
<tr>
<td></td>
<td><code>UPPER(str)</code></td>
<td>转大写</td>
<td><code>UPPER(&#39;abc&#39;)</code></td>
<td><code>&#39;ABC&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>LOWER(str)</code></td>
<td>转小写</td>
<td><code>LOWER(&#39;ABC&#39;)</code></td>
<td><code>&#39;abc&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>REPLACE(str, from_str, to_str)</code></td>
<td>字符串替换</td>
<td><code>REPLACE(&#39;abcabc&#39;, &#39;a&#39;, &#39;x&#39;)</code></td>
<td><code>&#39;xbcxbc&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>SUBSTRING(str, pos, len)</code></td>
<td>截取字符串</td>
<td><code>SUBSTRING(&#39;abcdef&#39;, 2, 3)</code></td>
<td><code>&#39;bcd&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>TRIM(str)</code></td>
<td>去除字符串首尾空格</td>
<td><code>TRIM(&#39;  abc &#39;)</code></td>
<td><code>&#39;abc&#39;</code></td>
</tr>
<tr>
<td>数值函数</td>
<td><code>ABS(n)</code></td>
<td>绝对值</td>
<td><code>ABS(-10)</code></td>
<td><code>10</code></td>
</tr>
<tr>
<td></td>
<td><code>ROUND(n, d)</code></td>
<td>四舍五入到小数点后 d 位</td>
<td><code>ROUND(3.14159, 2)</code></td>
<td><code>3.14</code></td>
</tr>
<tr>
<td></td>
<td><code>CEIL(n)</code></td>
<td>向上取整</td>
<td><code>CEIL(2.3)</code></td>
<td><code>3</code></td>
</tr>
<tr>
<td></td>
<td><code>FLOOR(n)</code></td>
<td>向下取整</td>
<td><code>FLOOR(2.7)</code></td>
<td><code>2</code></td>
</tr>
<tr>
<td></td>
<td><code>MOD(a, b)</code></td>
<td>取模</td>
<td><code>MOD(10, 3)</code></td>
<td><code>1</code></td>
</tr>
<tr>
<td></td>
<td><code>RAND()</code></td>
<td>生成0到1之间随机数</td>
<td><code>RAND()</code></td>
<td><code>0.123456789</code>（示例）</td>
</tr>
<tr>
<td></td>
<td><code>TRUNCATE(n, d)</code></td>
<td>截断数字到小数点后 d 位</td>
<td><code>TRUNCATE(3.4567, 2)</code></td>
<td><code>3.45</code></td>
</tr>
<tr>
<td>日期时间函数</td>
<td><code>NOW()</code></td>
<td>当前日期时间</td>
<td><code>NOW()</code></td>
<td><code>&#39;2025-07-25 20:30:00&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>CURDATE()</code></td>
<td>当前日期</td>
<td><code>CURDATE()</code></td>
<td><code>&#39;2025-07-25&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>CURTIME()</code></td>
<td>当前时间</td>
<td><code>CURTIME()</code></td>
<td><code>&#39;20:30:00&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>DATE_FORMAT(date, fmt)</code></td>
<td>格式化日期</td>
<td><code>DATE_FORMAT(NOW(), &#39;%Y-%m-%d&#39;)</code></td>
<td><code>&#39;2025-07-25&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>DATEDIFF(a, b)</code></td>
<td>计算日期差（a - b）天数</td>
<td><code>DATEDIFF(&#39;2025-08-01&#39;, &#39;2025-07-25&#39;)</code></td>
<td><code>7</code></td>
</tr>
<tr>
<td></td>
<td><code>TIMESTAMPDIFF(unit, a, b)</code></td>
<td>计算两时间差，单位可选</td>
<td><code>TIMESTAMPDIFF(DAY, &#39;2025-07-25&#39;, &#39;2025-08-01&#39;)</code></td>
<td><code>7</code></td>
</tr>
<tr>
<td></td>
<td><code>ADDDATE(date, n)</code></td>
<td>日期加n天</td>
<td><code>ADDDATE(&#39;2025-07-25&#39;, 5)</code></td>
<td><code>&#39;2025-07-30&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>SUBDATE(date, n)</code></td>
<td>日期减n天</td>
<td><code>SUBDATE(&#39;2025-07-25&#39;, 5)</code></td>
<td><code>&#39;2025-07-20&#39;</code></td>
</tr>
<tr>
<td>聚合函数</td>
<td><code>COUNT(*)</code></td>
<td>统计行数</td>
<td><code>SELECT COUNT(*) FROM users</code></td>
<td><code>100</code></td>
</tr>
<tr>
<td></td>
<td><code>SUM(col)</code></td>
<td>求和</td>
<td><code>SUM(price)</code></td>
<td><code>12345.67</code></td>
</tr>
<tr>
<td></td>
<td><code>AVG(col)</code></td>
<td>平均值</td>
<td><code>AVG(score)</code></td>
<td><code>87.5</code></td>
</tr>
<tr>
<td></td>
<td><code>MAX(col)</code></td>
<td>最大值</td>
<td><code>MAX(age)</code></td>
<td><code>60</code></td>
</tr>
<tr>
<td></td>
<td><code>MIN(col)</code></td>
<td>最小值</td>
<td><code>MIN(created_at)</code></td>
<td><code>&#39;2020-01-01&#39;</code></td>
</tr>
<tr>
<td>条件判断函数</td>
<td><code>IF(expr, a, b)</code></td>
<td>条件判断，类似三元运算符</td>
<td><code>IF(score &gt; 60, &#39;及格&#39;, &#39;不及格&#39;)</code></td>
<td><code>&#39;及格&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>IFNULL(expr, val)</code></td>
<td>如果 expr 为 NULL，返回 val</td>
<td><code>IFNULL(name, &#39;未知&#39;)</code></td>
<td><code>&#39;未知&#39;</code></td>
</tr>
<tr>
<td></td>
<td><code>NULLIF(a, b)</code></td>
<td>若 a &#x3D; b，则返回 NULL，否则 a</td>
<td><code>NULLIF(1,1)</code> → <code>NULL</code></td>
<td><code>NULL</code></td>
</tr>
<tr>
<td></td>
<td><code>CASE WHEN ... THEN ... ELSE ... END</code></td>
<td>多条件判断</td>
<td>参见下方示例</td>
<td></td>
</tr>
</tbody></table>
<h3 id="MySQL完整性约束"><a href="#MySQL完整性约束" class="headerlink" title="MySQL完整性约束"></a>MySQL完整性约束</h3><h4 id="主键约束"><a href="#主键约束" class="headerlink" title="主键约束"></a>主键约束</h4><p><strong>primary key</strong>(<strong>唯一且不为空</strong>)</p>
<h4 id="自增键约束"><a href="#自增键约束" class="headerlink" title="自增键约束"></a>自增键约束</h4><p><strong>auto_increment(整型自增)</strong></p>
<h4 id="唯一键约束"><a href="#唯一键约束" class="headerlink" title="唯一键约束"></a>唯一键约束</h4><p><strong>unique(不可以重复但是可以为空)</strong></p>
<h4 id="非空约束"><a href="#非空约束" class="headerlink" title="非空约束"></a>非空约束</h4><p><strong>not null</strong></p>
<h4 id="默认值约束"><a href="#默认值约束" class="headerlink" title="默认值约束"></a>默认值约束</h4><p><strong>default</strong></p>
<h4 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h4><p><strong>foreign key</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE USER(</span><br><span class="line">id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT COMMENT &#x27;用户的主键id&#x27;,</span><br><span class="line">nickname varchar(50) UNIQUE NOT NULL COMMENT &#x27;用户的昵称&#x27;,</span><br><span class="line">age TINYINT UNSIGNED NOT NULL DEFAULT 18,</span><br><span class="line">sex ENUM(&#x27;male&#x27;,&#x27;female&#x27;));</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+----------+-----------------------+------+-----+---------+----------------+</span><br><span class="line">| Field    | Type                  | Null | Key | Default | Extra          |</span><br><span class="line">+----------+-----------------------+------+-----+---------+----------------+</span><br><span class="line">| id       | int unsigned          | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| nickname | varchar(50)           | NO   | UNI | NULL    |                |</span><br><span class="line">| age      | tinyint unsigned      | NO   |     | 18      |                |</span><br><span class="line">| sex      | enum(&#x27;male&#x27;,&#x27;female&#x27;) | YES  |     | NULL    |                |</span><br><span class="line">+----------+-----------------------+------+-----+---------+----------------+</span><br><span class="line">4 rows in set (0.03 sec)</span><br></pre></td></tr></table></figure>

<h3 id="关系型数据库表设计"><a href="#关系型数据库表设计" class="headerlink" title="关系型数据库表设计"></a>关系型数据库表设计</h3><p>好的设计减少数据冗余。</p>
<h4 id="一对一关系"><a href="#一对一关系" class="headerlink" title="一对一关系"></a>一对一关系</h4><p><strong>在子表中增加一列，关联父表的主键</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">用户User表：父表</span><br><span class="line">uid 	name 	age		sex</span><br><span class="line">1000	zhang	20		M</span><br><span class="line">1020	liu		21 		W</span><br><span class="line">2010 	Wang	22		M</span><br><span class="line">身份信息Info 子表</span><br><span class="line">uid 	cardid		addrinfo</span><br><span class="line">1020    112233		aaa</span><br><span class="line">2010    334455		bbb</span><br><span class="line">1000	556677		ccc</span><br></pre></td></tr></table></figure>

<h4 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h4><p><strong>在子表中增加一列，关联父表的主键</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">电商系统：</span><br><span class="line">用户User,商品Product,订单Order</span><br><span class="line">用户和商品：没有关系</span><br><span class="line">用户和订单：一对多的关系 User为父表 Order为子表 在子表中增加一列，关联父表的主键</span><br><span class="line">商品和订单：多对多的关系</span><br><span class="line">User: </span><br><span class="line">uid 	name 	age		sex</span><br><span class="line">1000	zhang	20		M</span><br><span class="line">1020	liu		21 		W</span><br><span class="line">2010 	Wang	22		M</span><br><span class="line">Product:</span><br><span class="line">pid		pname	price	amount</span><br><span class="line">1		手机		600		100</span><br><span class="line">2		笔记本		2000	50</span><br><span class="line">3		电池		10		200</span><br><span class="line">Order:</span><br><span class="line">orderid		uid		pid		number		money	totalprice	addrinfo</span><br><span class="line">O1000		1000	1		1			600		4640		海定区</span><br><span class="line">O1000		1000	2		2			4000	4640		海定区</span><br><span class="line">O1000		1000	3		5			40		4640		海定区</span><br><span class="line">O2000		2010	2		1			2000	2000		平谷区</span><br></pre></td></tr></table></figure>

<h4 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h4><p><strong>增加一个中间表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">电商系统：</span><br><span class="line">用户User,商品Product,订单Order</span><br><span class="line">用户和商品：没有关系</span><br><span class="line">用户和订单：一对多的关系 User为父表 Order为子表 在子表中增加一列，关联父表的主键</span><br><span class="line">商品和订单：多对多的关系 </span><br><span class="line">User: </span><br><span class="line">uid 	name 	age		sex</span><br><span class="line">1000	zhang	20		M</span><br><span class="line">1020	liu		21 		W</span><br><span class="line">2010 	Wang	22		M</span><br><span class="line">Product:</span><br><span class="line">pid		pname	price	amount</span><br><span class="line">1		手机		600		100</span><br><span class="line">2		笔记本		2000	50</span><br><span class="line">3		电池		10		200</span><br><span class="line">Order:</span><br><span class="line">orderid		uid		pid		number		money	totalprice	addrinfo</span><br><span class="line">O1000		1000	1		1			600		4640		海定区</span><br><span class="line">O1000		1000	2		2			4000	4640		海定区</span><br><span class="line">O1000		1000	3		5			40		4640		海定区</span><br><span class="line">O2000		2010	2		1			2000	2000		平谷区</span><br><span class="line">商品和订单：多对多的关系 </span><br><span class="line">发现Order表太过冗余了，所以增加一个中间表</span><br><span class="line">订单内容表</span><br><span class="line">OrderList:</span><br><span class="line">orderid		pid		number	money</span><br><span class="line">O1000		1		1		600</span><br><span class="line">O1000		2		2		4000</span><br><span class="line">O1000		3		4		40</span><br><span class="line">O2000  		2		1		2000</span><br><span class="line">这里中间表可以orderid,pid为联合主键。</span><br><span class="line">所以Order表改变</span><br><span class="line">Order:</span><br><span class="line">orderid		uid		totalprice	addrinfo</span><br><span class="line">O1000		1000		4640		海定区</span><br><span class="line">O2000		2010		2000		平谷区</span><br></pre></td></tr></table></figure>

<h3 id="关系型数据库范式"><a href="#关系型数据库范式" class="headerlink" title="关系型数据库范式"></a>关系型数据库范式</h3><p><strong>应用数据库范式可以带来许多好处，最重要的到处归结为三点：</strong></p>
<ol>
<li><strong>减少数据冗余(这是最主要的好处，其他好处都是由此而附带的)</strong></li>
<li><strong>消除异常(插入异常，更新异常，删除异常)</strong></li>
<li><strong>让数据组织的更加和谐</strong></li>
</ol>
<p><strong>但是数据库范式绝对不是越高越好，范式越高，意味着表越多，多表联合查询的机率就越大，SQL的效率就越低。</strong></p>
<h4 id="第一范式（1NF）"><a href="#第一范式（1NF）" class="headerlink" title="第一范式（1NF）"></a>第一范式（1NF）</h4><p><strong>每一列保持原子特性</strong></p>
<p>列都是基本数据项，不能够再进行分割，否则设计成一对多的实体关系。例如表中的地址字段，可以再细分为省，市，区等不可再分割的字段。<strong>不符合第一范式不能称作关系型数据库。</strong></p>
<h4 id="第二范式（2NF）"><a href="#第二范式（2NF）" class="headerlink" title="第二范式（2NF）"></a>第二范式（2NF）</h4><p><strong>属性完全依赖于主键，主要针对联合主键</strong></p>
<p>非主属性完全依赖于主关键字，如果不是完全依赖主键，应该拆分成新的实体，设计成一对多的实体关系。</p>
<p>例如：选课关系表为SelectCourse(学号，姓名，年龄，课程名称，成绩，学分),(学号，课程名称)是联合主键，但是学分字段只和课程名称有关，和学号无关，相当于只依赖联合主键的其中一个字段，不符合第二范式。姓名，年龄不符合第二范式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">所以这里需要拆分</span><br><span class="line">学生表</span><br><span class="line">学号		姓名		年龄</span><br><span class="line"></span><br><span class="line">课程表</span><br><span class="line">课程id	课程名称	学分</span><br><span class="line"></span><br><span class="line">中间表：选课情况</span><br><span class="line">学号 课程id 成绩</span><br></pre></td></tr></table></figure>

<h4 id="第三范式（3NF）"><a href="#第三范式（3NF）" class="headerlink" title="第三范式（3NF）"></a>第三范式（3NF）</h4><p><strong>属性不依赖于其他非主属性</strong></p>
<p>示例：学生关系表为Student(学号，姓名，年龄，所在学院，学院地点，学院电话)，学号是主键，但是学院电话只依赖于所在学院，并不依赖于主键学号，所以不符合第三范式，应该把学院专门设计成一张表，学生表和学院表，两个是一对多的关系。</p>
<p><strong>一般关系型数据库满足第三范式就可以了。</strong></p>
<h4 id="BC范式（BCNF）"><a href="#BC范式（BCNF）" class="headerlink" title="BC范式（BCNF）"></a>BC范式（BCNF）</h4><p><strong>每个表中只有一个候选键</strong></p>
<h4 id="第四范式（4NF）"><a href="#第四范式（4NF）" class="headerlink" title="第四范式（4NF）"></a>第四范式（4NF）</h4><p><strong>消除表中的多值依赖</strong></p>
<h2 id="MySQL核心SQL"><a href="#MySQL核心SQL" class="headerlink" title="MySQL核心SQL"></a>MySQL核心SQL</h2><h3 id="结构化查询语句SQL"><a href="#结构化查询语句SQL" class="headerlink" title="结构化查询语句SQL"></a>结构化查询语句SQL</h3><p>SQL是结构化查询语言，它是关系型数据库的通用语言。</p>
<p>SQL主要可以划分三个类别：</p>
<ol>
<li>DDL语句：数据定义语言，这些语句定义了不同的数据库，表，列，索引等数据库对象的定义。通常的语句关键字主要包括<strong>create,drop,alter</strong>等。</li>
<li>DML语句：数据操纵语句，用于添加，删除，更新和查询数据库记录，并检查数据完整性，常用的语句关键字主要包括<strong>insert,delete,update和select</strong>等。</li>
<li>DCL语句：数据控制语句，用于控制不同的许可和访问级别的语句。这些语句定义了数据库，表，字段，用户的访问权限和安全级别。主要的语句关键字包括<strong>grant,revoke</strong>等。</li>
</ol>
<h3 id="库操作"><a href="#库操作" class="headerlink" title="库操作"></a>库操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查询数据库</span><br><span class="line">show databases;</span><br><span class="line">#创建数据库</span><br><span class="line">create database ChatDB;</span><br><span class="line">#删除数据库</span><br><span class="line">drop database ChatDB;</span><br><span class="line">#选择数据库</span><br><span class="line">use ChatDB;</span><br></pre></td></tr></table></figure>

<h3 id="表操作"><a href="#表操作" class="headerlink" title="表操作"></a>表操作</h3><p>查看表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br></pre></td></tr></table></figure>

<p>创建表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table user(</span><br><span class="line">    id int unsigned primary key not null auto_increment,</span><br><span class="line">    name varchar(50) unique not null,</span><br><span class="line">    age tinyint not null,</span><br><span class="line">    sex enum(&#x27;M&#x27;,&#x27;W&#x27;) not null)engine=INNODB default charset=utf8;</span><br></pre></td></tr></table></figure>

<p>查看表结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc user;</span><br></pre></td></tr></table></figure>

<p>查看建表sql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show create table user\G</span><br></pre></td></tr></table></figure>

<p>删除表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop table user;</span><br></pre></td></tr></table></figure>

<h3 id="CRUD操作"><a href="#CRUD操作" class="headerlink" title="CRUD操作"></a>CRUD操作</h3><h4 id="insert增加"><a href="#insert增加" class="headerlink" title="insert增加"></a>insert增加</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into user(nickname,name,age,sex) values(&#x27;fixbug&#x27;,&#x27;zhangsan&#x27;,22,&#x27;M&#x27;);</span><br><span class="line">insert into user(nickname,name,age,sex) values(&#x27;666&#x27;,&#x27;li si&#x27;,21,&#x27;W&#x27;),(&#x27;888&#x27;,&#x27;gao yang&#x27;,20,&#x27;M&#x27;);</span><br></pre></td></tr></table></figure>

<p><strong>这里有个问题：就是一次全插入和多次插入最后结果都是相同的，那么他们有什么区别。</strong></p>
<p><img src="/MYSQLlearning/2.png" alt="2"></p>
<p><strong>由上图，多次插入会导致tcp连接次数增多，消耗资源。</strong></p>
<h4 id="update修改"><a href="#update修改" class="headerlink" title="update修改"></a>update修改</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">update user set age=23 where name=&#x27;zhangsan&#x27;;</span><br><span class="line">update user set age=age+1 where id=3;</span><br></pre></td></tr></table></figure>

<h4 id="delete删除"><a href="#delete删除" class="headerlink" title="delete删除"></a>delete删除</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete from user where age=23;</span><br><span class="line">delete from user where age between 20 and 22;</span><br><span class="line">delete from user;</span><br></pre></td></tr></table></figure>

<h4 id="select查询"><a href="#select查询" class="headerlink" title="select查询"></a>select查询</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select * from user;</span><br><span class="line">select id,nickname,name,age,sex from user;</span><br><span class="line">select id,name from user;</span><br><span class="line">select id,nickname,name,age,sex from user where sex=&#x27;M&#x27; and age&gt;=20 and age&lt;=25;</span><br><span class="line">select id,nickname,name,age,sex from user where sex=&#x27;M&#x27; and age between 20 and 25;</span><br><span class="line">select id,nickname,name,age,sex from user where sex=&#x27;W&#x27; or age&gt;=22;</span><br></pre></td></tr></table></figure>

<p><strong>去重distinct</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select distinct name from user;</span><br></pre></td></tr></table></figure>

<p><strong>空值查询</strong></p>
<p><strong>is [not] null</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where name is null;</span><br></pre></td></tr></table></figure>

<p><strong>union合并查询</strong></p>
<p><strong>把两个结果合并起来，union默认去重，不用修饰distinct，all表示显示所有重复值。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select country from websites union all select country from apps order by country;</span><br></pre></td></tr></table></figure>

<p><strong>带in子查询</strong></p>
<p><strong>[不]包含这些元素</strong></p>
<p><strong>[not] in(元素1，元素2，…，元素3)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from user where id in(10,20,30,40,50);</span><br><span class="line">select * from user where id not in(10,20,30,40,50);</span><br><span class="line">select * from user where id in(select stu_id from grade where average&gt;=60.0);</span><br></pre></td></tr></table></figure>

<p><strong>分页查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select id,nickname,name,age,sex from user limit 10;</span><br><span class="line">select id,nickname,name,age,sex from user limit 2000,10#偏移2000，再取10个</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain select * from user where name=&#x27;zhangsan&#x27;;</span><br><span class="line">explain:查看SQL语句的执行计划(但是MySQL的自身优化检测不到，可能体现的数据不对)，主键会注册主键索引，唯一键会注册索引，通过索引查询，直接查到（查一次），不需要遍历去查。如果通过没有注册索引的字段去查询的话，就可能变成整表查询（查很多次）。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">select id,nickname,name,age,sex from user limit 10;#没有设计limit 10，它是查完整表返回结果，设计了limit 10 查到10个符合条件的数据就返回。</span><br><span class="line">所以这就可以利用这个特性</span><br><span class="line">在通过一些非注册索引的字段查找时，可以通过limit,提高查询速度。</span><br><span class="line">select * from t_user where email =&#x27;1000001@fixbug.com&#x27;;</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| id      | email              | password |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| 1000001 | 1000001@fixbug.com | 1000001  |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">1 row in set (0.66 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t_user where email =&#x27;1000001@fixbug.com&#x27; limit 1;</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| id      | email              | password |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| 1000001 | 1000001@fixbug.com | 1000001  |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">1 row in set (0.33 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">分页查询优化</span><br><span class="line">select * from t_user limit 1000000,20;</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| id      | email              | password |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| 1000001 | 1000001@fixbug.com | 1000001  |</span><br><span class="line">| 1000002 | 1000002@fixbug.com | 1000002  |</span><br><span class="line">| 1000003 | 1000003@fixbug.com | 1000003  |</span><br><span class="line">| 1000004 | 1000004@fixbug.com | 1000004  |</span><br><span class="line">| 1000005 | 1000005@fixbug.com | 1000005  |</span><br><span class="line">| 1000006 | 1000006@fixbug.com | 1000006  |</span><br><span class="line">| 1000007 | 1000007@fixbug.com | 1000007  |</span><br><span class="line">| 1000008 | 1000008@fixbug.com | 1000008  |</span><br><span class="line">| 1000009 | 1000009@fixbug.com | 1000009  |</span><br><span class="line">| 1000010 | 1000010@fixbug.com | 1000010  |</span><br><span class="line">| 1000011 | 1000011@fixbug.com | 1000011  |</span><br><span class="line">| 1000012 | 1000012@fixbug.com | 1000012  |</span><br><span class="line">| 1000013 | 1000013@fixbug.com | 1000013  |</span><br><span class="line">| 1000014 | 1000014@fixbug.com | 1000014  |</span><br><span class="line">| 1000015 | 1000015@fixbug.com | 1000015  |</span><br><span class="line">| 1000016 | 1000016@fixbug.com | 1000016  |</span><br><span class="line">| 1000017 | 1000017@fixbug.com | 1000017  |</span><br><span class="line">| 1000018 | 1000018@fixbug.com | 1000018  |</span><br><span class="line">| 1000019 | 1000019@fixbug.com | 1000019  |</span><br><span class="line">| 1000020 | 1000020@fixbug.com | 1000020  |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">20 rows in set (0.27 sec)</span><br><span class="line">select * from t_user where id&gt;1000000 limit 20;</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| id      | email              | password |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| 1000001 | 1000001@fixbug.com | 1000001  |</span><br><span class="line">| 1000002 | 1000002@fixbug.com | 1000002  |</span><br><span class="line">| 1000003 | 1000003@fixbug.com | 1000003  |</span><br><span class="line">| 1000004 | 1000004@fixbug.com | 1000004  |</span><br><span class="line">| 1000005 | 1000005@fixbug.com | 1000005  |</span><br><span class="line">| 1000006 | 1000006@fixbug.com | 1000006  |</span><br><span class="line">| 1000007 | 1000007@fixbug.com | 1000007  |</span><br><span class="line">| 1000008 | 1000008@fixbug.com | 1000008  |</span><br><span class="line">| 1000009 | 1000009@fixbug.com | 1000009  |</span><br><span class="line">| 1000010 | 1000010@fixbug.com | 1000010  |</span><br><span class="line">| 1000011 | 1000011@fixbug.com | 1000011  |</span><br><span class="line">| 1000012 | 1000012@fixbug.com | 1000012  |</span><br><span class="line">| 1000013 | 1000013@fixbug.com | 1000013  |</span><br><span class="line">| 1000014 | 1000014@fixbug.com | 1000014  |</span><br><span class="line">| 1000015 | 1000015@fixbug.com | 1000015  |</span><br><span class="line">| 1000016 | 1000016@fixbug.com | 1000016  |</span><br><span class="line">| 1000017 | 1000017@fixbug.com | 1000017  |</span><br><span class="line">| 1000018 | 1000018@fixbug.com | 1000018  |</span><br><span class="line">| 1000019 | 1000019@fixbug.com | 1000019  |</span><br><span class="line">| 1000020 | 1000020@fixbug.com | 1000020  |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">20 rows in set (0.00 sec)</span><br><span class="line">可以看出明显的效率不同</span><br><span class="line">select * from t_user limit 1000000,20;通过limit偏移，是会扫表的，所以耗费效率，所以我们要通过有索引的字段来约束条件，他就不会扫前面的，因为索引。这样效率也提高了</span><br><span class="line">select * from t_user where id&gt;1000000 limit 20;id&gt;的取值一般为上一页最后一条数据的id值</span><br></pre></td></tr></table></figure>

<p><strong>排序order by</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select id,nickname,name,age,sex from user where sex=&#x27;M&#x27; and age&gt;=20 and age&lt;=25 order by age asc;(默认为升序)</span><br><span class="line">select id,nickname,name,age,sex from user where sex=&#x27;M&#x27; and age&gt;=20 and age&lt;=25 order by age desc;(降序)</span><br><span class="line">select id,nickname,name,age,sex from user where sex=&#x27;M&#x27; and age&gt;=20 and age&lt;=25 order by name,age asc;(先按name升序，当name相同时，再按age升序)</span><br></pre></td></tr></table></figure>

<p><strong>分组group by</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select sex from user group by sex;</span><br><span class="line">select count(id) as number,sex from user group by sex;</span><br><span class="line">select count(id),age from user group by age having age&gt;20;</span><br><span class="line">select age,sex,count(*) from user group by age,sex;</span><br></pre></td></tr></table></figure>

<p><strong>group by后面再筛选就不能用where,要使用having。</strong></p>
<p><strong>在使用 ORDER BY 和 GROUP BY 时，建议对相关字段建立索引。</strong></p>
<p><strong>如果排序或分组字段没有索引，MySQL 在执行过程中通常会采用 filesort 或创建临时表，这会导致性能下降。通过 EXPLAIN 分析语句时，可以在 Extra 字段看到 Using filesort，这意味着：</strong></p>
<ul>
<li><strong>MySQL 首先会读取满足条件的数据；</strong></li>
<li><strong>将其加载到内存或临时表中；</strong></li>
<li><strong>然后在内存或磁盘上进行排序；</strong></li>
<li><strong>最终返回排序后的结果。</strong></li>
</ul>
<p><strong>由于这涉及额外的 CPU 和磁盘 I&#x2F;O 操作，效率会显著降低，尤其是在数据量较大时。因此，在 ORDER BY 或 GROUP BY 中应尽量使用已经建立索引的字段，以提升查询性能。</strong></p>
<h3 id="连接查询"><a href="#连接查询" class="headerlink" title="连接查询"></a>连接查询</h3><p><img src="/MYSQLlearning/3.png" alt="3"></p>
<h4 id="内连接查询"><a href="#内连接查询" class="headerlink" title="内连接查询"></a>内连接查询</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#on a.uid=c.uid 区分大表和小表，按照（where过滤后）数据量来区分，小表永远是整表扫描，然后去大表搜索。所以大表建索引才是最有效的</span><br><span class="line">#从student小表中取出所有的a.uid，然后拿着这些uid去exame大表搜素。</span><br><span class="line">#对于inner join内连接，过滤条件写在where的后面和on连接条件里面(会优化成where去过滤)，效果一样的。</span><br><span class="line">select a.uid,a.name,a.age,a.sex,c.score from student a </span><br><span class="line">inner join exame c </span><br><span class="line">on a.uid=c.uid </span><br><span class="line">where c.uid=1 and c.cid=2;</span><br><span class="line"></span><br><span class="line">select a.uid,a.name,a.age,a.sex,b.cid,b.cname,b.credit,c.score from exame c</span><br><span class="line">inner join student a on c.uid=a.uid</span><br><span class="line">inner join course b on c.cid=b.cid</span><br><span class="line">where c.uid=1 and c.cid=2;</span><br></pre></td></tr></table></figure>

<p><strong>内连接查询解决单张表的limit分页偏移量的消耗，这个问题可以采用有索引的字段来约束条件来使分页偏移量的消耗消失。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t_user where id&gt;1000000 limit 20;</span><br></pre></td></tr></table></figure>

<p><strong>可是如果我们不知道这个id的值要取多少，偏移量必须写。又该如何提升效率。可以利用临时表存储所需信息的id，再通过这张表和原表inner join进而查出更多的信息。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">select id,email,password from t_user limit 1500000,10;</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| id      | email              | password |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| 1500001 | 1500001@fixbug.com | 1500001  |</span><br><span class="line">| 1500002 | 1500002@fixbug.com | 1500002  |</span><br><span class="line">| 1500003 | 1500003@fixbug.com | 1500003  |</span><br><span class="line">| 1500004 | 1500004@fixbug.com | 1500004  |</span><br><span class="line">| 1500005 | 1500005@fixbug.com | 1500005  |</span><br><span class="line">| 1500006 | 1500006@fixbug.com | 1500006  |</span><br><span class="line">| 1500007 | 1500007@fixbug.com | 1500007  |</span><br><span class="line">| 1500008 | 1500008@fixbug.com | 1500008  |</span><br><span class="line">| 1500009 | 1500009@fixbug.com | 1500009  |</span><br><span class="line">| 1500010 | 1500010@fixbug.com | 1500010  |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">10 rows in set (0.71 sec)</span><br><span class="line">这是正常查的</span><br><span class="line">select id from t_user limit 1500000,10;</span><br><span class="line">+---------+</span><br><span class="line">| id      |</span><br><span class="line">+---------+</span><br><span class="line">| 1500001 |</span><br><span class="line">| 1500002 |</span><br><span class="line">| 1500003 |</span><br><span class="line">| 1500004 |</span><br><span class="line">| 1500005 |</span><br><span class="line">| 1500006 |</span><br><span class="line">| 1500007 |</span><br><span class="line">| 1500008 |</span><br><span class="line">| 1500009 |</span><br><span class="line">| 1500010 |</span><br><span class="line">+---------+</span><br><span class="line">10 rows in set (0.20 sec)</span><br><span class="line">#我们发现查单个字段效率会提高</span><br><span class="line">#所以我们建立临时表（小表）存储带索引的字段，再通过inner join查出相同的结果</span><br><span class="line">select a.id,a.email,a.password from t_user a inner join (select id from t_user limit 1500000,10) b on a.id=b.id;</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| id      | email              | password |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">| 1500001 | 1500001@fixbug.com | 1500001  |</span><br><span class="line">| 1500002 | 1500002@fixbug.com | 1500002  |</span><br><span class="line">| 1500003 | 1500003@fixbug.com | 1500003  |</span><br><span class="line">| 1500004 | 1500004@fixbug.com | 1500004  |</span><br><span class="line">| 1500005 | 1500005@fixbug.com | 1500005  |</span><br><span class="line">| 1500006 | 1500006@fixbug.com | 1500006  |</span><br><span class="line">| 1500007 | 1500007@fixbug.com | 1500007  |</span><br><span class="line">| 1500008 | 1500008@fixbug.com | 1500008  |</span><br><span class="line">| 1500009 | 1500009@fixbug.com | 1500009  |</span><br><span class="line">| 1500010 | 1500010@fixbug.com | 1500010  |</span><br><span class="line">+---------+--------------------+----------+</span><br><span class="line">10 rows in set (0.18 sec)</span><br><span class="line">#肉眼可见的效率提高了。</span><br></pre></td></tr></table></figure>

<h4 id="外连接查询"><a href="#外连接查询" class="headerlink" title="外连接查询"></a>外连接查询</h4><p><strong>左连接查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#把left这边的表所有的数据显示出来，在右表中不存在相应数据，则显示NULL，这里就不存在大小表的区分了，左表整表扫描。</span><br><span class="line">select a.* from User a left join orderlist b on a.uid=b.uid where a.orderid is null;</span><br></pre></td></tr></table></figure>

<p><strong>右连接查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#把right这边的表所有的数据显示出来，在左表中不存在相应数据，则显示NULL，这里就不存在大小表的区分了，右表整表扫描。</span><br><span class="line">select a.* from User a right join orderlist b on a.uid=b.uid where b.orderid is null;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#外连接经常用于查找某个用户没有，不存在</span><br><span class="line">#查找没有考试的学生</span><br><span class="line">select * from student where uid not in (select distinct uid from exame);</span><br><span class="line">#select distinct uid from exame 会产生一张中间表存储结果供外面的sql来查询</span><br><span class="line">#not in对于索引的命中并不高</span><br><span class="line">#可以看出用上述方法效率不是很高</span><br><span class="line">select a.* from student a left join exame b on a.uid=b.uid where b.cid is null;</span><br><span class="line">#这样也可以实现效果</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select a.* from student a left join exame b on a.uid=b.uid where b.cid=3;</span><br><span class="line">select a.* from student a inner join exame b on a.uid=b.uid where b.cid=3;</span><br><span class="line">#上述两句效果是一样的，为什么呢，这时候我们用explain查看左连接，先查b表，再查a表，这就和左连接的查表顺序不符，和内连接相符。</span><br><span class="line">#原因在于where筛选数据后b为小表，所以又成了内连接了。所以在外连接查找时，where不要跟具体的筛选，放在on后，where后跟判断null.</span><br><span class="line">select a.* from student a left join exame b on a.uid=b.uid and b.cid=3 where b.cid is null;</span><br><span class="line">#带有一定条件的查询某个用户没有做什么要像上述写的。</span><br></pre></td></tr></table></figure>

<h2 id="MySQL存储引擎"><a href="#MySQL存储引擎" class="headerlink" title="MySQL存储引擎"></a>MySQL存储引擎</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">一张表，MySQL一般如何存储</span><br><span class="line">表的结构，数据，索引</span><br><span class="line">存储引擎直接影响上面内容的存储方式</span><br></pre></td></tr></table></figure>

<p><strong>MyISAM不支持事务，也不支持外键，索引采用非聚集索引，其优势是访问的速度快，对事务完整性没有要求，以select,insert为主的应用基本上都可以使用这个引擎来创建表。MyISAM的表在磁盘上存储三个文件，其文件名都和表名相同，扩展名分别是：</strong></p>
<p><strong>.frm(存储表定义)</strong></p>
<p><strong>.MYD(MYData，存储数据)</strong></p>
<p><strong>.MYI(MYIndex，存储索引)</strong></p>
<p><strong>InnoDB存储引擎提供了具有提交，回滚和崩溃恢复能力的事务安全，支持自动增长列，外键等功能，索引采用聚集索引，索引和数据存储在同一个文件，所以InnoDB的表在磁盘上有两个文件，其文件名都和表名相同，扩展名分别是：</strong></p>
<p><strong>.frm(存储表定义)</strong></p>
<p><strong>.ibd(存储数据和索引)</strong></p>
<p><strong>MEMORY存储引擎使用存在内存中的内容创建表。每个MEMORY表实际只对应一个磁盘文件，格式是.frm(表结构定义)。MEMORY类型的表访问非常快，因为它的数据是放在内存中的，并且默认使用HASH索引（不适合做范围查询），但是一旦服务关闭，表中的数据就会丢失掉。</strong></p>
<h3 id="各存储引擎区别"><a href="#各存储引擎区别" class="headerlink" title="各存储引擎区别"></a>各存储引擎区别</h3><h3 id="MySQL-存储引擎对比"><a href="#MySQL-存储引擎对比" class="headerlink" title="MySQL 存储引擎对比"></a>MySQL 存储引擎对比</h3><table>
<thead>
<tr>
<th>特性&#x2F;存储引擎</th>
<th><strong>InnoDB</strong></th>
<th><strong>MyISAM</strong></th>
<th><strong>Memory</strong></th>
</tr>
</thead>
<tbody><tr>
<td>🔒 锁机制</td>
<td>✅ 行级锁 + 表级锁混合（默认行锁，支持多版本并发控制 MVCC）</td>
<td>❌ 仅支持表级锁，写入或更新时整个表被锁定</td>
<td>❌ 仅支持表级锁</td>
</tr>
<tr>
<td>🌳 B-树索引</td>
<td>✅ 支持，<strong>聚簇索引（主键）</strong>存储数据，辅助索引存主键</td>
<td>✅ 支持，<strong>非聚簇索引</strong>，索引与数据分离</td>
<td>✅ 支持（基于哈希或 B-Tree，可设置）</td>
</tr>
<tr>
<td>🔗 哈希索引</td>
<td>⚠️ 不支持（只有 Adaptive Hash Index，InnoDB 内部使用）</td>
<td>❌ 不支持</td>
<td>✅ 默认使用哈希索引，<strong>也支持 BTree（可配置）</strong></td>
</tr>
<tr>
<td>🔐 外键支持</td>
<td>✅ 支持（定义级联删除、更新等外键约束）</td>
<td>❌ 不支持</td>
<td>❌ 不支持</td>
</tr>
<tr>
<td>🔁 事务支持</td>
<td>✅ 支持完整事务（ACID），回滚、提交、一致性恢复</td>
<td>❌ 不支持事务机制</td>
<td>❌ 不支持事务</td>
</tr>
<tr>
<td>📚 索引缓存</td>
<td>✅ 支持（通过 Buffer Pool 缓存索引和数据）</td>
<td>✅ 支持（<strong>只缓存索引，不缓存数据</strong>）</td>
<td>❌ 不缓存索引（数据在内存中，系统重启即失）</td>
</tr>
<tr>
<td>💾 数据缓存</td>
<td>✅ 支持（Buffer Pool 中同时缓存数据和索引）</td>
<td>❌ 不支持数据缓存（每次查询都需从磁盘读取数据）</td>
<td>✅ 所有数据在内存中，速度极快</td>
</tr>
</tbody></table>
<p><strong>锁机制：表示数据库在并发请求访问的时候，多个事务在操作时，并发操作的粒度。</strong></p>
<p><strong>B-树索引和哈希索引：主要是加速SQL的查询速度。</strong></p>
<p><strong>外键：子表的字段依赖父表的主键，设置两张表的依赖关系。</strong></p>
<p><strong>事务：多个SQL语句，保证他们共同执行的原子操作，要么成功，要么失败，不能只成功一部分，失败需回滚事务。</strong></p>
<p><strong>索引缓存和数据缓存：和MySQL Server的查询缓存相关，在没有对数据和索引做修改之前，重复查询可以不用进行磁盘I&#x2F;O(数据库的性能提升，目的是为了减少磁盘I&#x2F;O操作来提升数据库访问效率)，读取上一次内存中查询的缓存即可。</strong></p>
<h2 id="MySQL索引"><a href="#MySQL索引" class="headerlink" title="MySQL索引"></a>MySQL索引</h2><p><strong>当表中的数据量到达几十万甚至上百万的时候，SQL查询所花费的时间会很长，导致业务超时出错，此时就需要用索引来加速SQL查询。</strong></p>
<p><strong>由于索引也是需要存储索引文件的，因此对索引的使用也会涉及磁盘I&#x2F;O操作。如果索引创建过多，使用不当，会造成SQL查询时，进行大量无用的磁盘I&#x2F;O操作，降低了SQL的查询效率，适得其反，所以掌握良好得索引创建原则非常重要。</strong></p>
<h3 id="索引分类"><a href="#索引分类" class="headerlink" title="索引分类"></a>索引分类</h3><p><strong>索引是创建在表上的，是对数据库表一列或者多列的值进行排序的一种结果。索引的核心是提高查询的速度。</strong></p>
<p><strong>物理上(聚集索引&amp;非聚集索引)&#x2F;逻辑上(以下六种)</strong></p>
<p><strong>索引的优点：提高查询效率</strong></p>
<p><strong>索引的缺点：索引并非越多越好，过多的索引会导致CPU使用率居高不下，由于数据的改变，会造成索引文件的改动，过多的磁盘I&#x2F;O造成CPU负荷太重。</strong></p>
<ol>
<li><strong>普通索引：没有任何限制条件，可以给任何类型的字段创建普通索引。(创建新表&amp;已创建表，数量是不限的，一张表的一次sql查询只能用一个索引 where a&#x3D;1 and b&#x3D;’M’只用其中一个)</strong></li>
<li><strong>唯一性索引：使用UNIQUE修饰的字段，值不能够重复，主键索引就隶属于唯一性索引。</strong></li>
<li><strong>主键索引：使用Primary Key修饰的字段会自动创建索引。</strong></li>
<li><strong>单列索引：在一个字段上创建索引</strong></li>
<li><strong>多列索引：在表的多个字段上创建索引（多列索引必须使用到第一个列，才能使用到多列索引，否则索引用不上）</strong></li>
<li><strong>全文索引：使用FULLTEXT参数可以设置全文索引，只支持CHAR,VARCHAR和TEXT类型的字段上，常用于数据量较大的字符串类型上，可以提高查询速度。(线上项目支持专门的搜索功能，给后台服务器增加专门的搜索引擎支持快速高效的搜索 elasticsearch简称es C++开源的搜索引擎 搜狗的workflow,所以最好不要部署到mysql里)</strong></li>
</ol>
<h3 id="索引创建和删除"><a href="#索引创建和删除" class="headerlink" title="索引创建和删除"></a>索引创建和删除</h3><p><strong>注意：</strong></p>
<ol>
<li><strong>经常作为where条件过滤的字段考虑添加索引</strong></li>
<li><strong>字符串创建索引时，尽量规定索引的长度，而不能让索引值的长度key_len过长</strong></li>
<li><strong>索引字段涉及类型强转，mysql函数调用，表达式计算等，索引就用不上了（索引失效）。</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from t_user where password=&#x27;1000000&#x27;;</span><br><span class="line">select * from t_user where password=1000000;</span><br><span class="line">password是个varchar类型，加了索引，上面两句的耗时量不同。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#创建表的时候指定索引字段：</span><br><span class="line">CREATE TABLE index1(id INT,</span><br><span class="line">                    name VARCHAR(20),</span><br><span class="line">                    sex ENUM(&#x27;male&#x27;,&#x27;female&#x27;),</span><br><span class="line">                   	INDEX(id));</span><br><span class="line">#在已经创建的表上添加索引：添加索引。后续用这个字段查，索引一定会用到吗，不一定，如果使用索引所消耗的数据量和扫表的数据量差不多的话，会优化成直接扫表。不用索引</span><br><span class="line">CREATE [UNIQUE]INDEX 索引名 ON 表名（属性名（length）[ASC|DESC]）;length为索引的长度,一般在给字符串字段加索引时写明长度</span><br><span class="line">create index pwdidx on t_user(password);</span><br><span class="line">#删除索引</span><br><span class="line">DROP INDEX 索引名 ON 表名;</span><br></pre></td></tr></table></figure>

<h3 id="索引的执行过程"><a href="#索引的执行过程" class="headerlink" title="索引的执行过程"></a>索引的执行过程</h3><h4 id="explain查看执行计划"><a href="#explain查看执行计划" class="headerlink" title="explain查看执行计划"></a>explain查看执行计划</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM user WHERE id = 1;</span><br></pre></td></tr></table></figure>

<p><strong>EXPLAIN 关键字段详细说明表格</strong></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>详细解释</th>
</tr>
</thead>
<tbody><tr>
<td><strong>id</strong></td>
<td>表示查询中每个 SELECT 子句的唯一标识符。 数值越大，优先级越高，越早执行。常见于子查询和联合查询中。</td>
</tr>
<tr>
<td><strong>select_type</strong></td>
<td>表示查询的类型（即 SELECT 的种类）： 🔹 <code>SIMPLE</code>：简单查询，没有子查询或 UNION 🔹 <code>PRIMARY</code>：最外层的主查询 🔹 <code>SUBQUERY</code>：SELECT 在 WHERE 中嵌套 🔹 <code>DERIVED</code>：FROM 子句中的子查询（派生表）🔹<code>UNION</code>：UNION 中的第二个及以后查询 🔹 <code>DEPENDENT SUBQUERY</code>：依赖外层查询结果的子查询</td>
</tr>
<tr>
<td><strong>table</strong></td>
<td>当前访问的表名或别名，若为临时表，则会显示 <code>derivedN</code> 或 <code>unionN</code></td>
</tr>
<tr>
<td><strong>partitions</strong></td>
<td>如果使用了分区表，显示所访问的分区。无分区则为 NULL</td>
</tr>
<tr>
<td><strong>type（访问类型）</strong></td>
<td>🔥 评估索引使用效率的核心字段，从优到劣如下： 1. <code>system</code>（表只有一行） 2. <code>const</code>（通过主键或唯一索引查询常量） 3. <code>eq_ref</code>（唯一索引 + 连接） 4. <code>ref</code>（普通索引 + 连接） 5. <code>range</code>（范围查询，如 <code>&gt;</code>、<code>BETWEEN</code>） 6. <code>index</code>（全索引扫描） 7. <code>ALL</code>（全表扫描 ⚠️ 需优化）</td>
</tr>
<tr>
<td><strong>possible_keys</strong></td>
<td>显示可能用于查询的索引列表。 不一定表示最终用到了。 如果是 <code>NULL</code>，说明没有可用索引。</td>
</tr>
<tr>
<td><strong>key</strong></td>
<td>实际使用的索引名称。 为 <code>NULL</code> 则表示未使用任何索引。</td>
</tr>
<tr>
<td><strong>key_len</strong></td>
<td>实际使用的索引长度（单位是字节）， 由字段类型、字符集等决定。 ⚠️ 并不等于整个索引长度，仅表示此次查询使用了其中多少部分。</td>
</tr>
<tr>
<td><strong>ref</strong></td>
<td>显示哪个字段或常量被用来与索引中的列进行比较： 如：<code>const</code>（常量）、<code>func</code>（函数）、<code>table.column</code>（表字段）等</td>
</tr>
<tr>
<td><strong>rows</strong></td>
<td>MySQL 预计需要读取的记录行数（不是返回行数），越少越好。 是估算值，不一定准确。</td>
</tr>
<tr>
<td><strong>filtered</strong></td>
<td>表示通过 WHERE 条件过滤后，预估保留的记录百分比。 值为百分比形式，100 表示全部通过。</td>
</tr>
<tr>
<td><strong>Extra</strong></td>
<td>显示额外的执行细节，非常重要： 🔹 <code>Using index</code>：覆盖索引，无需回表 🔹 <code>Using where</code>：使用了 WHERE 过滤条件 🔹 <code>Using temporary</code>：使用了临时表（如GROUP BY） 🔹 <code>Using filesort</code>：需要额外排序（ORDER BY） 🔹 <code>Using index condition</code>：使用了 Index Condition Pushdown（ICP） 🔹 <code>Impossible WHERE</code>：WHERE 条件永远不成立</td>
</tr>
</tbody></table>
<h3 id="索引的底层实现原理"><a href="#索引的底层实现原理" class="headerlink" title="索引的底层实现原理"></a>索引的底层实现原理</h3><p><strong>数据库索引是存储在磁盘上的，当数据量大时，就不能把整个索引全部加载到内存了，只能逐一加载每一个磁盘块（对应索引树的节点），索引树越低，越矮胖，磁盘IO次数就少。</strong></p>
<p><strong>MySQL支持两种索引，一种是B-树索引，一种是哈希索引，大家知道，B-树和哈希表在查询时的效率是非常高的。</strong></p>
<p><strong>这里主要讨论MySQL InnoDB的存储引擎，基于B-树(但实际上MySQL采用的是B+树结构)的索引结构。</strong></p>
<p><strong>B-树是一种m阶平衡树，叶子节点都在同一层，由于每个节点存储的数据量比较大，索引整个B-树的层数是非常低的，基本不超过三层。</strong></p>
<p><strong>由于磁盘的读取也是按照block块操作的(内存是按page页面操作的)，因此B-树的节点大小一般设置为和磁盘块大小一致，这样一个B-树节点，就可以通过一次磁盘I&#x2F;O把一个磁盘块的数据全部存储下来，所以当使用B-树存储索引的时候，磁盘I&#x2F;O的操作次数是最少的(MySQL的读写效率，主要集中在磁盘I&#x2F;O)。</strong></p>
<p><img src="/MYSQLlearning/4.png" alt="4"></p>
<p><strong>为什么MySQL(MyISAM和InnoDB)索引底层选择B+树而不是B树呢？</strong></p>
<ol>
<li><strong>索引+数据内容分散在不同的节点上，离根节点近，搜索就快；离根节点远，搜索就慢！花费的磁盘IO次数不平均，每一行数据花费的时间也不平均。</strong></li>
<li><strong>每一个非叶子节点，不仅仅要存储索引(key),还要存储索引值所在的那一行的data数据。一个节点所能存放的索引key值的个数，比只能存储key值的节点的个数要少的多！！！</strong></li>
<li><strong>这棵树不方便做范围搜索，整表遍历看起来也不方便。</strong></li>
</ol>
<p><strong>有上面的三个原因，由B+树来构建索引。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.每一个非叶子节点，只存放key,不存储data!</span><br><span class="line">好处就是一个节点存放的key值更多，B+树在理论上来说，层数会更低一些，搜索的效率会更好一些。</span><br><span class="line">2.叶子节点上存储了所有的索引值+数据data:搜索每一个索引对应的值data,都需要跑到叶子节点上，这样每一行记录搜索的时间是非常平均的。</span><br><span class="line">3.叶子节点被串在一个链表当中，形成了一个有序的链表，如果要进行索引树的搜索&amp;整表搜索，直接遍历叶子节点的有序链表即可！或者做范围查询的时候，直接遍历叶子节点的有序链表即可！</span><br></pre></td></tr></table></figure>

<h4 id="InnoDB的主键和二级索引树"><a href="#InnoDB的主键和二级索引树" class="headerlink" title="InnoDB的主键和二级索引树"></a>InnoDB的主键和二级索引树</h4><p><img src="/MYSQLlearning/5.png" alt="5"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select * from student where age=20 order by name;</span><br><span class="line">如果只给age添加索引，行不行？还有什么没考虑到吗？</span><br><span class="line">如果只给age加索引，oder by name 会触发using filesort十分消耗资源，order by可以在name上加索引，但是一次sql,只能使用一次索引。</span><br><span class="line">所以我们这里要使用联合索引(多列索引)</span><br><span class="line">key:age+name 在B+树的链表中先按age排序，再按name排序；age相同，按name进行排序！！！</span><br><span class="line">多列索引必须使用到第一个列，才能使用到多列索引，否则索引用不上</span><br></pre></td></tr></table></figure>

<h4 id="MyISAM的主键和二级索引树"><a href="#MyISAM的主键和二级索引树" class="headerlink" title="MyISAM的主键和二级索引树"></a>MyISAM的主键和二级索引树</h4><p><img src="/MYSQLlearning/6.png" alt="6"></p>
<h4 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h4><p><img src="/MYSQLlearning/7.png" alt="7"></p>
<h4 id="InnoDB自适应哈希索引"><a href="#InnoDB自适应哈希索引" class="headerlink" title="InnoDB自适应哈希索引"></a>InnoDB自适应哈希索引</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">这个数据结构和哈希索引的数据结构是一样的。</span><br><span class="line">InnoDB存储引擎检测到同样的二级索引不断被使用，有回表，(使用等值搜索)，那么底层会根据这个二级索引优化，在内存上根据二级索引树（B+树）上的二级索引值，在内存上构建一个哈希索引，来加强搜索。毕竟等值查询的效率是O(1);</span><br><span class="line">但是自适应哈希索引本身的数据维护也是需要耗费性能的，并不是说自适应哈希索引在任何情况下都会提升二级索引的查询性能！根据参数指标，来具体分析是否打开或者关闭自适应哈希索引。</span><br><span class="line">show engine innodb status\G 能看到两个比较重要的信息：</span><br><span class="line">1.RW_latch等到的线程数量(自适应哈希索引默认分配8个分区)，同一个分区等待的线程数量过多，会造成自适应哈希索引搜索的效率低可以关闭自适应哈希索引</span><br><span class="line">2.走自适应哈希索引搜索的效率（低）和二级索引树搜索的效率（高）可以关闭自适应哈希索引</span><br></pre></td></tr></table></figure>

<p><strong>SQL和索引的优化问题，如何切入？</strong></p>
<p><strong>explain 分析sql</strong></p>
<p><strong>项目&#x3D;》很多业务&#x3D;》各种各样的sql 千条，万条</strong></p>
<p><strong>流程：从什么地方能够获取哪些运行时间长，耗性能的sql;然后再用explain去使用它。</strong></p>
<p><strong>1.可以使用慢查询日志slow_query_log，设置合理的，业务可以接受的慢查询时间！！</strong></p>
<p><strong>2.压测执行各种业务。</strong></p>
<p><strong>3.查看慢查询日志，找出所有执行耗时的sql。</strong></p>
<p><strong>4.用explain分析这些耗时的sql</strong></p>
<h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a><strong>慢查询日志</strong></h3><p><strong>MySQL可以设置慢查询日志，当SQL执行的时间超过我们设定的时间，那么这些SQL就会被记录在慢查询日志当中，然后我们通过查看日志，用explain分析这些SQL的执行计划，来判断为什么效率低下，是没有使用到索引？还是索引本身创建的有问题？或者是索引使用到了，但是由于表的数据量太大，花费的时间就是很长，那么此时我们可以把表分为n个小表，比如订单表按年份分成多个小表。</strong></p>
<p>慢查询日志相关参数如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;%slow_query%&#x27;;</span><br><span class="line">+---------------------+---------------------------------------------------------+</span><br><span class="line">| Variable_name       | Value                                                   |</span><br><span class="line">+---------------------+---------------------------------------------------------+</span><br><span class="line">| slow_query_log      | OFF                                                     |</span><br><span class="line">| slow_query_log_file | /var/lib/mysql/yustone-VMware-Virtual-Platform-slow.log |</span><br><span class="line">+---------------------+---------------------------------------------------------+</span><br><span class="line">2 rows in set (0.27 sec)</span><br></pre></td></tr></table></figure>

<p>打开慢查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global slow_query_log=ON;</span><br></pre></td></tr></table></figure>

<p>慢查询日志记录了包含所以执行时间超过参数long_query_time(单位：秒)所设置值的SQL语句的日志，在MySQL上用命令可以查看。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;long%&#x27;;</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| Variable_name   | Value     |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| long_query_time | 10.000000 |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>这个值是可以修改的，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set long_query_time=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>修改完成后，执行sql后可以去对应文件&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;yustone-VMware-Virtual-Platform-slow.log查看。</p>
<h2 id="MySQL事务"><a href="#MySQL事务" class="headerlink" title="MySQL事务"></a>MySQL事务</h2><h3 id="事务概念"><a href="#事务概念" class="headerlink" title="事务概念"></a>事务概念</h3><p><strong>一个事务是由一条或者多条对数据库操作的SQL语句所组成的一个不可分割的单元，只有当事务中的所有操作都正常执行完了，整个事务才会被提交到数据库；如果有部分事务处理失败，那么事务就要回退到最初的状态，因此，事务要么全部执行成功要么全部失败。</strong></p>
<ol>
<li><strong>事务是一组SQL语句的执行，要么全部成功，要么全部失败，不能出现部分成功，部分失败的结果。保证事务执行的原子操作。</strong></li>
<li><strong>事务的所有SQL语句全部执行成功，才能提交(commit)事务，把结果写回磁盘。</strong></li>
<li><strong>事务执行过程中，有的SQL出现错误，那么事务必须要回滚(rollback)到最初的状态。</strong></li>
</ol>
<h3 id="ACID特性"><a href="#ACID特性" class="headerlink" title="ACID特性"></a>ACID特性</h3><p><strong>每一个事务必须满足下面的4个特性：</strong></p>
<p><strong>事务的原子性(Atomic):</strong></p>
<p><strong>事务是一个不可分割的整体，事务必须具有原子特性，及当数据修改时，要么全执行，要么全不执行，即不允许事务部分的完成。</strong></p>
<p><strong>事务的一致性(Consistency):</strong></p>
<p><strong>一个事务执行之前和执行之后，数据库数据必须保持一致性状态。数据库的一致性状态必须由用户来负责，由并发控制机制实现。就拿网上购物来说，你只有让商品出库，又让商品进入顾客的购物车才能构成一个完整的事务。</strong></p>
<p><strong>事务的隔离性(Isolation):</strong></p>
<p><strong>当两个或者多个事务并发执行时，为了保证数据的安全性，将一个事务内部的操作与其他事务的操作隔离起来，不被其他正在执行的事务所看到，使得并发执行的各个事务之间不能互相影响。</strong></p>
<p><strong>事务的持久性(Durability):</strong></p>
<p><strong>事务完成(commit)以后，DBMS保证它对数据库中的数据的修改是永久性的(可能出现内存把数据写回磁盘时出现断电)，即使数据库因为故障出错，也应该能够恢复数据！（利用redo log:重做日志 保证数据库的永久性）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">事务的ACID特性：</span><br><span class="line">ACD:是由mysql的redo log和undo log机制来保证的。</span><br><span class="line">I:隔离性，是由mysql事务的锁机制来实现保证的。</span><br></pre></td></tr></table></figure>

<h3 id="事务并发存在的问题"><a href="#事务并发存在的问题" class="headerlink" title="事务并发存在的问题"></a>事务并发存在的问题</h3><p>事务处理不经隔离，并发执行事务时通常会发生以下的问题：</p>
<p><strong>脏读（Dirty Read）:一个事务读取了另一个事务未提交的数据。例如当事务A和事务B并发执行时，当事务A更新后，事务B查询读取到A尚未提交的数据，此时事务A回滚，则事务B读到的数据就是无效的脏数据。（事务B读取了事务A尚未提交的数据）。</strong>（杜绝）</p>
<p><strong>不可重复读（NonRepeatable Read）:一个事务的操作导致另一个事务前后两次读到不同的数据。例如当事务A和事务B并发执行时，当事务B查询读取数据后，事务A更新操作更改事务B查询到的数据，此时事务B再次去读该数据，发现前后两次读的数据不一样。（事务B读取了事务A已提交的数据）</strong>（看业务能不能接受）</p>
<p><strong>虚读(Phantom Read) 幻读：一个事务的操作导致另一个事务前后查询的结果数据量不同。例如当事务A和事务B并发执行时，当事务B查询读取数据后，事务A新增或者删除了一条满足事务B查询条件的记录，此时事务B再去查询，发现查询到前一次不存在的记录。或者前一次查询的一些记录不见了。（事务B读取了事务A(已提交)新增加的数据或者读不到事务A删除的数据）。</strong>（看业务能不能接受）</p>
<h3 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h3><p>MySQL支持的四种隔离级别是：</p>
<ol>
<li><strong>TRANSACTION_READ_UNCOMMITTED。未提交读。说明在提交前一个事务可以看到另一个事务的变化。这样读脏数据，不可重复读和虚读都是被允许的。</strong></li>
<li><strong>TRANSACTION_READ_COMMITTED。已提交读。说明读取未提交的数据是不允许的。这个级别仍然允许不可重复读和虚读产生。</strong></li>
<li><strong>TRANSACTION_REPEATABLE_READ。可重复读。说明事务保证能够再次读取相同的数据而不会失败，都是相同的数据，但虚读仍然会出现。可以解决一部分的幻读（insert&#x2F;delete）,但是解决不了update造成的幻读。</strong></li>
<li><strong>TRANSACTION_SERIALIZABLE。串行化。是最高的事务级别，他防止读脏数据，不可重复读和虚读。</strong></li>
</ol>
<p><strong>MySQL默认隔离级别：可重复读,oracle的默认隔离级别：已提交读。</strong></p>
<h3 id="MySQL的事务处理命令"><a href="#MySQL的事务处理命令" class="headerlink" title="MySQL的事务处理命令"></a>MySQL的事务处理命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select @@autocommit;#查看事务是自动(1)还是手动(0)</span><br><span class="line"></span><br><span class="line">set autocommit=0;#设置事务为手动(在当前会话生效)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#MyISAM:不支持事务的！</span><br><span class="line">#InnoDB:最大的特点：支持事务，支持行锁</span><br><span class="line">try&#123;</span><br><span class="line">	begin;#开始一个事务</span><br><span class="line">	SQL语句</span><br><span class="line">	</span><br><span class="line">	commit;#提交一个事务</span><br><span class="line">&#125;catch(... err)&#123;</span><br><span class="line">	rollback;#回滚一个事务</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SAVEPOINT point1;设置一个名字为point1的保存点</span><br><span class="line">ROLLBACK TO point1;事务回滚到保存点point1,而不是回滚到初始状态</span><br><span class="line">SET SESSION transaction_isolation = &#x27;REPEATABLE-READ&#x27;;设置事务的隔离级别</span><br><span class="line">SELECT @@transaction_isolation;查询事务的隔离级别</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@transaction_isolation;</span><br><span class="line">+-------------------------+</span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+-------------------------+</span><br><span class="line">| REPEATABLE-READ         |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.02 sec)</span><br></pre></td></tr></table></figure>

<h2 id="MySQL的锁机制"><a href="#MySQL的锁机制" class="headerlink" title="MySQL的锁机制"></a>MySQL的锁机制</h2><p><img src="/MYSQLlearning/8.png" alt="8"></p>
<h3 id="表级锁-行级锁"><a href="#表级锁-行级锁" class="headerlink" title="表级锁&amp;行级锁"></a>表级锁&amp;行级锁</h3><p><strong>表级锁：对整张表加锁。开销小，加锁快，不会出现死锁；锁粒度大，发生锁冲突的概率高，并发读低。</strong></p>
<p><strong>行级锁：对某行记录加锁。开销大，加锁慢，会出现死锁；锁粒度最小，发生锁冲突的概率最低，并发度高。</strong></p>
<h3 id="排它锁和共享锁"><a href="#排它锁和共享锁" class="headerlink" title="排它锁和共享锁"></a>排它锁和共享锁</h3><p><strong>排它锁（Exclusive）,又称为X锁，写锁。</strong></p>
<p><strong>共享锁（Shared）,又称为S锁，读锁。</strong></p>
<p><strong>X锁和S锁之间有以下关系： SS可以兼容，XS,SX,XX之间是互斥的</strong></p>
<ol>
<li><strong>一个事务对数据对象O加了S锁，可以对O进行读取操作但不能进行更新操作。加锁期间其他事务能对O加S锁但不能加X锁。</strong></li>
<li><strong>一个事务对数据对象O加了X锁，就可以对O进行读取和更新。加锁期间其他事务不能对O加任何锁。</strong></li>
<li><strong>手动加锁：select…lock in share mode强制获取共享锁，select…for update获取排它锁</strong></li>
</ol>
<h3 id="InnoDB行级锁"><a href="#InnoDB行级锁" class="headerlink" title="InnoDB行级锁"></a>InnoDB行级锁</h3><h4 id="行级锁"><a href="#行级锁" class="headerlink" title="行级锁"></a>行级锁</h4><p><strong>InnoDB存储引擎支持事务处理，表支持行级锁定，并发能力更好。</strong></p>
<ol>
<li><strong>InnoDB行锁是通过给索引上的索引项加锁来实现的，而不是给表的行记录加锁实现的，这就意味着只有通过索引数据，InnoDB才使用行级锁，否则InnoDB将使用表锁。</strong></li>
<li><strong>由于InnoDB的行锁实现是针对索引字段添加的锁，不是针对行记录加的锁，因此虽然访问的是InnoDB引擎下表的不同行，但是如果使用相同的索引字段值作为过滤条件，依然会发生锁冲突，只能串行进行，不能并发进行。</strong></li>
<li><strong>即使SQL中使用了索引，但是经历MySQL的优化器后，如果认为全表扫描比使用索引效率更高，此时会放弃使用索引，因此不会使用行锁，而是使用表锁，比如对一些很小的表，MySQL就不会去使用索引。</strong></li>
</ol>
<h4 id="间隙锁-gap-lock"><a href="#间隙锁-gap-lock" class="headerlink" title="间隙锁(gap lock)"></a>间隙锁(gap lock)</h4><p><img src="/MYSQLlearning/9.png" alt="9"></p>
<p><strong>当我们用范围条件而不是相等条件检索数据，并请求共享或排它锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做间隙，InnoDB也会对这个间隙加锁，这个锁机制就是所谓的间隙锁。举例来说，假如user表中只有101条记录，其userid的值分别为1，2，100，101，下面的SQL:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where userid&gt;100 for update;</span><br></pre></td></tr></table></figure>

<p><strong>是一个范围条件的检索，InnoDB不仅会对符合条件的userid值为101的记录加锁，也会对userid大于101(但是这些记录不存在)的间隙加锁，防止其他事务在表的末尾增加数据。</strong></p>
<p><strong>InnoDB使用间隙锁的目的，为了防止幻读，以满足串行化隔离级别的要求，对于上面的例子，要是不使用间隙锁，如果其他事务插入了userid大于100的任何记录，那么本事务如果再次执行上述语句，就会发生幻读。</strong></p>
<p><img src="/MYSQLlearning/10.png" alt="10"></p>
<h3 id="InnoDB表级锁"><a href="#InnoDB表级锁" class="headerlink" title="InnoDB表级锁"></a>InnoDB表级锁</h3><p>在绝大部分情况下都应该使用行锁，因为事务和行锁往往是选择InnoDB的理由，但个别情况下也使用表级锁；</p>
<ol>
<li>事务需要更新大部分或全部数据，表又比较大，如果使用默认的行锁，不仅这个事务执行效率低，而且可能造成其他事务长时间等待和锁冲突；</li>
<li>事务涉及多个表，比较复杂，很可能造成死锁，造成大量事务回滚。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLE user READ;读锁锁表</span><br><span class="line">LOCK TABLE user WRITE;写锁锁表</span><br><span class="line">事务执行。。。</span><br><span class="line">COMMIT/ROLLBACK;事务提交/回滚</span><br><span class="line">UNLOCK TABLES;本身自带提交事务，释放线程占用的所有表锁。</span><br></pre></td></tr></table></figure>

<h4 id="意向共享锁和意向排他锁"><a href="#意向共享锁和意向排他锁" class="headerlink" title="意向共享锁和意向排他锁"></a>意向共享锁和意向排他锁</h4><p><strong>意向共享锁（IS锁）:事务计划给记录加行共享锁，事务在给一行记录加共享锁前，必须先取得该表的IS锁。</strong></p>
<p><strong>意向排他锁（IX锁）:事务计划给记录加行排他锁，事务在给一行记录加排他锁前，必须先取得该表的IX锁</strong></p>
<p><strong>IS和IX之间是兼容的，没有互斥</strong></p>
<p><img src="/MYSQLlearning/13.png" alt="13"></p>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p><strong>MyISAM表锁是deadlock free的，这是因为MyISAM总是一次获得所需的全部锁，要么全部满足，要么等待，因此不会出现死锁。但在InnoDB中，除单个SQL组成的事务外，锁是逐步获得的，即锁的粒度比较小，这就决定了在InnoDB中发生死锁是可能的。</strong></p>
<p><img src="/MYSQLlearning/14.png" alt="14"></p>
<p><strong>死锁问题一般都是我们自己的应用造成的，和多线程编程的死锁情况相似，大部分都是由于我们多个线程在获取多个锁资源的时候，获取的顺序不同而导致的死锁问题。因此我们应用在对数据库的多个表作更新的时候，不同的代码段，应对这些表按相同的顺序进行更新操作，以防止锁冲突导致死锁问题。</strong></p>
<h3 id="锁的优化建议"><a href="#锁的优化建议" class="headerlink" title="锁的优化建议"></a>锁的优化建议</h3><ol>
<li><strong>尽量使用较低的隔离级别</strong></li>
<li><strong>设计合理的索引并尽量使用索引访问数据，使加锁更加准确，减少锁冲突的机会提高并发能力</strong></li>
<li><strong>选择合理的事务大小，小事务发生锁冲突的概率小</strong></li>
<li><strong>不同的程序访问一组表时，应尽量约定以相同的顺序访问各表；对一个表而言，尽可能以固定的顺序存取表中的行。这样可以大大减少死锁的机会</strong></li>
<li><strong>尽量用相等条件访问数据，这样可以避免间隙锁对并发插入的影响</strong></li>
<li><strong>不要申请超过实际需要的锁级别</strong></li>
<li><strong>除非必须，查询时不要显式加锁</strong></li>
</ol>
<h3 id="redo-log和undo-log"><a href="#redo-log和undo-log" class="headerlink" title="redo log和undo log"></a>redo log和undo log</h3><p><strong>统称为事务日志。区别于binlog是MySQL Server层的日志，这两个属于存储引擎层的日志。</strong></p>
<p><strong>redo log：重做日志。</strong></p>
<p><strong>undo log: 回滚日志</strong></p>
<p><strong>redo log:	用于记录事务操作的变化，确保事务的持久性。redo log是在事务开始后就开始记录，不管事务是否提交都会记录下来，在异常发生时（如数据持久化过程中掉电），InnoDB会使用redo log恢复到掉电前的时刻，保证数据的完整性。</strong></p>
<p><strong>innodb_log_buffer_size默认是16M,就是redo log缓冲区的大小，它随着事务开始，就开始写redo log,如果事务比较大，为了避免事务执行过程中花费过多磁盘IO,可以设置比较大的redo log缓存，节省磁盘IO。</strong></p>
<p><strong>InnoDB修改操作数据，不是直接修改磁盘上的数据，实际只是修改Buffer Pool的数据。InnoDB总是先把Buffer Pool中的数据改变记录到redo log中，用来进行崩溃后的数据恢复。优先记录redo log,然后再慢慢的将Buffer Pool的脏数据刷新到磁盘上。</strong></p>
<p><strong>innodb_log_group_home_dir指定的目录下的两个文件：ib_logfile0,ib_logfile1,该文件被称作重做日志。</strong></p>
<p><strong>buffer pool缓存池：</strong></p>
<p><strong>作用：加速读和加速写，直接操作data page,写redo log修改就算完成，有专门的线程去做把buffer pool的dirty page写入磁盘。</strong></p>
<p><img src="/MYSQLlearning/15.png" alt="15"></p>
<p><strong>undo log:	保存了事务发生之前的数据的一个版本，用于事务执行时的回滚操作，同时也是实现多版本并发控制（MVCC）下读操作的关键技术。</strong></p>
<p><strong>在创建表时，除了自己设定的字段，mysql会自动加一些字段，其中DB_TRX_ID：事务ID  DB_ROLL_PTR：回滚指针</strong></p>
<p> <strong>DB_ROLL_PTR：回滚指针指向修改前的数据，修改前的数据在undo log中，当然当前数据库里的数据是最新的。回滚的话，直接从undo log调就可以。</strong></p>
<p><img src="/MYSQLlearning/11.png" alt="11"></p>
<h3 id="MVCC多版本并发控制"><a href="#MVCC多版本并发控制" class="headerlink" title="MVCC多版本并发控制"></a>MVCC多版本并发控制</h3><p><strong>MVCC是多版本并发控制，是MySQL中基于乐观锁理论实现隔离级别的方式，用于实现已提交读和可重复读隔离级别的实现，也经常称为多版本数据库。MVCC机制会生成一个数据请求时间点的一致性数据快照（Snapshot）,并用这个快照来提供一定级别（语句级或事务级）的一致性读取。从用户的角度来看，好像是数据库可以提供同一数据的多个版本（系统版本号和事务版本号）。</strong></p>
<p><strong>MVCC多版本并发控制中，读操作可以分为两类：</strong></p>
<p><strong>1.快照读（Snapshot read）</strong></p>
<p>​	<strong>读的是记录的可见版本，不用加锁，如select。</strong></p>
<p><strong>2.当前读（current read）</strong></p>
<p>​	<strong>读取的是记录的最新版本，并且当前读返回的记录。如insert,delete,update,select…lock in share mode&#x2F;for update</strong></p>
<p>​	<strong>MVCC:每一行记录实际上有多个版本，每个版本的记录除了数据本身之外，增加了其他字段</strong></p>
<p>​	<strong>DB_TRX_ID:记录当前的事务ID。</strong></p>
<p>​	<strong>DB_ROLL_PTR:指向undo log日志上数据的指针。</strong></p>
<p><strong>逻辑上来看，MVCC 就是为每个事务“搞出了一张表的快照”，但这张“表”并不是实际复制的，而是通过行级的历史版本 + 可见性判断规则拼出来的。</strong></p>
<p><strong>已提交读：每次执行语句的时候都重新生成一次快照（Read View）,每次select查询时。</strong></p>
<p><strong>可重复读：同一个事务开始的时候生成一个当前事务全局性的快照（Read View）,第一次select查询时。</strong></p>
<p><strong>快照内容读取原则：</strong></p>
<ol>
<li><strong>版本未提交无法读取生成快照</strong></li>
<li><strong>版本已提交，但是在快照创建后提交的，无法读取</strong></li>
<li><strong>版本已提交，但是在快照创建前提交的，可以读取</strong></li>
<li><strong>当前事务内自己的更新，可以读到。</strong></li>
</ol>
<p><img src="/MYSQLlearning/12.png" alt="12"></p>
<h2 id="MySQL优化"><a href="#MySQL优化" class="headerlink" title="MySQL优化"></a>MySQL优化</h2><p><img src="/MYSQLlearning/16.png" alt="16"></p>
<h2 id="MySQL日志"><a href="#MySQL日志" class="headerlink" title="MySQL日志"></a>MySQL日志</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;log_%&#x27;; #全局变量	设置&amp;状态	show variables &amp; show status</span><br><span class="line">+----------------------------------------+----------------------------------------+</span><br><span class="line">| Variable_name                          | Value                                  |</span><br><span class="line">+----------------------------------------+----------------------------------------+</span><br><span class="line">| log_bin                                | ON                                     |</span><br><span class="line">| log_bin_basename                       | /var/lib/mysql/binlog                  |</span><br><span class="line">| log_bin_index                          | /var/lib/mysql/binlog.index            |</span><br><span class="line">| log_bin_trust_function_creators        | OFF                                    |</span><br><span class="line">| log_bin_use_v1_row_events              | OFF                                    |</span><br><span class="line">| log_error                              | /var/log/mysql/error.log               |</span><br><span class="line">| log_error_services                     | log_filter_internal; log_sink_internal |</span><br><span class="line">| log_error_suppression_list             |                                        |</span><br><span class="line">| log_error_verbosity                    | 2                                      |</span><br><span class="line">| log_output                             | FILE                                   |</span><br><span class="line">| log_queries_not_using_indexes          | OFF                                    |</span><br><span class="line">| log_raw                                | OFF                                    |</span><br><span class="line">| log_replica_updates                    | ON                                     |</span><br><span class="line">| log_slave_updates                      | ON                                     |</span><br><span class="line">| log_slow_admin_statements              | OFF                                    |</span><br><span class="line">| log_slow_extra                         | OFF                                    |</span><br><span class="line">| log_slow_replica_statements            | OFF                                    |</span><br><span class="line">| log_slow_slave_statements              | OFF                                    |</span><br><span class="line">| log_statements_unsafe_for_binlog       | ON                                     |</span><br><span class="line">| log_throttle_queries_not_using_indexes | 0                                      |</span><br><span class="line">| log_timestamps                         | UTC                                    |</span><br><span class="line">+----------------------------------------+----------------------------------------+</span><br><span class="line">21 rows in set (0.06 sec)</span><br></pre></td></tr></table></figure>

<p>关于日志的配置需要到my.cnf去添加。</p>
<p><img src="/MYSQLlearning/17.png" alt="17"></p>
<h3 id="二进制日志"><a href="#二进制日志" class="headerlink" title="二进制日志"></a>二进制日志</h3><p><strong>二进制日志(BINLOG)记录了所有的DDL(数据定义语言)语句和DML(数据操纵语言)语句,但是不包括数据查询语句。语句以事件的形式保存，他描述了数据的更改过程。此日志对于灾难时的数据恢复起到极其重要的作用。</strong></p>
<p><strong>两个重要的应用场景：主从复制，数据恢复</strong></p>
<p><strong>查看binlog</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">show binary logs;</span><br><span class="line">+---------------+-----------+-----------+</span><br><span class="line">| Log_name      | File_size | Encrypted |</span><br><span class="line">+---------------+-----------+-----------+</span><br><span class="line">| binlog.000027 |       157 | No        |</span><br><span class="line">| binlog.000028 |       157 | No        |</span><br><span class="line">| binlog.000029 |       157 | No        |</span><br><span class="line">| binlog.000030 |       157 | No        |</span><br><span class="line">| binlog.000031 |       157 | No        |</span><br><span class="line">| binlog.000032 |       157 | No        |</span><br><span class="line">| binlog.000033 | 104857956 | No        |</span><br><span class="line">| binlog.000034 | 104857734 | No        |</span><br><span class="line">| binlog.000035 | 104857734 | No        |</span><br><span class="line">| binlog.000036 | 104857688 | No        |</span><br><span class="line">| binlog.000037 | 104857740 | No        |</span><br><span class="line">| binlog.000038 | 104857740 | No        |</span><br><span class="line">| binlog.000039 |  10635266 | No        |</span><br><span class="line">+---------------+-----------+-----------+</span><br><span class="line">13 rows in set (0.02 sec)</span><br></pre></td></tr></table></figure>

<p><strong>通过mysqlbinlog工具(mysql原生自带的工具)可以快速解析大量的binlog日志文件。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查看 binlog 日志内容</span><br><span class="line">mysqlbinlog /var/lib/mysql/mysql-bin.000001</span><br></pre></td></tr></table></figure>

<p><strong>mysql数据的恢复：过期数据的备份(data.sql)+bin-log数据恢复</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#bin-log数据恢复 除了通过位置恢复还可以通过时间恢复</span></span><br><span class="line">mysqlbinlog --start-position=775 --stop-position=1410 mysql-bin.000003 | mysql -u root -p</span><br><span class="line"><span class="comment">#过期数据的备份</span></span><br><span class="line">mysqldump -u root -p mytest user &gt; ~/user.sql</span><br><span class="line">mysqldump -u root -p --databases db1 [db2] &gt; ~/user.sql</span><br><span class="line">mysqldump -u root -p --all-databases &gt; ~/user.sql</span><br><span class="line">mysql界面下还原数据</span><br><span class="line"><span class="built_in">source</span> ~/user.sql</span><br><span class="line">或者</span><br><span class="line"><span class="built_in">cat</span> ~/data.sql | mysql -u root -p</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">前面导出的是mysql的记录</span><br><span class="line">我想直接导出数据</span><br><span class="line">bash下</span><br><span class="line">mysql -u root -p -D school -e <span class="string">&quot;select * from user where age&gt;18&quot;</span> &gt; ~/user.txt</span><br></pre></td></tr></table></figure>

<h2 id="SQL详细处理流程"><a href="#SQL详细处理流程" class="headerlink" title="SQL详细处理流程"></a>SQL详细处理流程</h2><p><img src="/MYSQLlearning/18.png" alt="18"></p>
<h2 id="MySQL集群"><a href="#MySQL集群" class="headerlink" title="MySQL集群"></a>MySQL集群</h2><p><strong>在实际生产环境中，如果对mysql数据库的读和写都在一台数据库服务器中操作，无论是在安全性，高可用性，还是高并发等各个方面都是不能满足实际需求的，一般要通过主从复制的方式来同步数据，再通过读写分离来提升数据库的并发负载能力。</strong></p>
<ol>
<li><strong>数据备份 -热备份&amp;容灾&amp;高可用。</strong></li>
<li><strong>读写分离，支持更大的并发。</strong></li>
</ol>
<h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p><strong>原理介绍</strong></p>
<p><img src="/MYSQLlearning/19.png" alt="19"></p>
<p><strong>主从复制的流程：两个日志binlog二进制日志&amp;relay log中继日志和三个线程(master的一个线程和slave的两个线程)</strong></p>
<ol>
<li><strong>主库的更新操作写入binlog二进制日志中。</strong></li>
<li><strong>master服务器创建一个binlog转储线程，将二进制日志内容发送到从服务器。</strong></li>
<li><strong>slave机器执行START SLAVE命令会在从服务器创建一个IO线程，接收master的binary log复制到其中继日志。首先slave开始一个工作线程(I&#x2F;O线程)，I&#x2F;O线程在master上打开一个普通的连接，然后开始binlog dump process,binlog dump process从master的二进制日志中读取事件，如果已经跟上master,它会睡眠并等待master产生新的事件，I&#x2F;O线程将这些事件写入中继日志。</strong></li>
<li><strong>sql slave thread(sql从线程)处理该过程的最后一步，sql线程从中继日志中读取事件，并重放其中的事件而更新slave机器的数据，使其与master的数据一致。只要该线程与I&#x2F;O线程保持一致，中继日志通常会位于os缓存中，所以中继日志的开销很小。</strong></li>
</ol>
<h3 id="mysql主从复制配置"><a href="#mysql主从复制配置" class="headerlink" title="mysql主从复制配置"></a>mysql主从复制配置</h3><p><strong>首先确认防火墙是否开放对应端口(使用ubtuntu)</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#防火墙（UFW）状态</span></span><br><span class="line"><span class="built_in">sudo</span> ufw status</span><br><span class="line"><span class="comment">#启用防火墙</span></span><br><span class="line"><span class="built_in">sudo</span> ufw <span class="built_in">enable</span></span><br><span class="line"><span class="comment">#开放指定端口</span></span><br><span class="line"><span class="built_in">sudo</span> ufw allow 8080</span><br><span class="line"><span class="comment">#仅开放 TCP：</span></span><br><span class="line"><span class="built_in">sudo</span> ufw allow 8080/tcp</span><br><span class="line"><span class="comment">#仅开放 UDP：</span></span><br><span class="line"><span class="built_in">sudo</span> ufw allow 8080/udp</span><br><span class="line"><span class="comment">#查看当前已开放的端口</span></span><br><span class="line"><span class="built_in">sudo</span> ufw status numbered</span><br><span class="line"><span class="comment">#关闭指定端口</span></span><br><span class="line"><span class="built_in">sudo</span> ufw delete allow 8080</span><br></pre></td></tr></table></figure>

<p>master配置：</p>
<ol>
<li><p>开启二进制日志，配置log_bin和全局唯一的server-id.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim /etc/my.cnf#编写配置文件</span><br><span class="line">server-id=1</span><br><span class="line">expire_logs_days=7</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart mysql#重启mysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个用于主从库通信用的账号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DROP USER IF EXISTS &#x27;mslave&#x27;@&#x27;从库ip(如果虚拟机NAT模式可以看错误日志看具体是那个ip)&#x27;;#删除user变量为mslave（如果要重新配置可以删除再配置）</span><br><span class="line">CREATE USER &#x27;mslave&#x27;@&#x27;从库ip(如果虚拟机NAT模式可以看错误日志看具体是那个ip)&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;1qaz@wsx&#x27;;</span><br><span class="line">查看 /var/log/mysql/error.log 中出现的访问主库失败信息，通常能看到连接的 IP</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#x27;mslave&#x27;@&#x27;和IP上同&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取binlog的日志文件名和position</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;show master status;</span><br><span class="line">show master status;</span><br><span class="line">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| binlog.000045 |     1056 |              |                  |                   |</span><br><span class="line">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>slave配置：</p>
<ol>
<li><p>配置全局唯一的server-id&#x3D;2(配置完需要重启mysql);</p>
</li>
<li><p>使用master创建的账户读取binlog同步数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=&#x27;主库ip&#x27;,</span><br><span class="line">master_port=3306,</span><br><span class="line">master_user=&#x27;mslave&#x27;,</span><br><span class="line">master_password=&#x27;1qaz@wsx&#x27;,</span><br><span class="line">master_log_file=&#x27; binlog.000045&#x27;,</span><br><span class="line">master_log_pos=1056;</span><br></pre></td></tr></table></figure>
</li>
<li><p>START SLAVE</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">START SLAVE#开启从库接受主库的binlog</span><br><span class="line">通过show slave status\G命令查看主从复制状态。</span><br><span class="line">STOP SLAVE;停止SLAVE，可以修改，再开始</span><br></pre></td></tr></table></figure>

<p><strong>show processlist查看mysql中正在运行的线程。</strong></p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果后续在从库出现错误了</span><br><span class="line">可以用</span><br><span class="line">stop slave;</span><br><span class="line">set global sql_slave_skip_counter=5;#跳过5个错误</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<h3 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h3><p><strong>读写分离就是在主服务器上修改，数据会同步到从服务器上，从服务器只能提供读取数据，不能写入，实现备份的同时也实现了数据库性能的优化，以及提升了服务器安全。</strong></p>
<p><img src="/MYSQLlearning/20.png" alt="20"></p>
<h3 id="Mycat读写分离配置"><a href="#Mycat读写分离配置" class="headerlink" title="Mycat读写分离配置"></a>Mycat读写分离配置</h3><p><strong>安装好mycat后，就要对配置进行修改</strong></p>
<p><strong>mycat&#x2F;conf&#x2F;server.xml：配置的是mycat的账户信息</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!--逻辑库--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultSchema&quot;</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>mycat&#x2F;conf&#x2F;schema.xml：配置读写分离，分库分表等内容</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">randomDataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- auto sharding by id (long) --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--splitTableNames 启用&lt;table name 属性使用逗号分割配置多个表,即多个表使用这个配置--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--fetchStoreNodeByJdbc 启用ER表使用JDBC方式获取DataNode--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>/&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--&lt;table name=&quot;customer&quot; primaryKey=&quot;id&quot; dataNode=&quot;dn1,dn2&quot; rule=&quot;sharding-by-intfile&quot; autoIncrement=&quot;true&quot; fetchStoreNodeByJdbc=&quot;true&quot;&gt;</span></span><br><span class="line"><span class="comment">		&lt;childTable name=&quot;customer_addr&quot; primaryKey=&quot;id&quot; joinKey=&quot;customer_id&quot; parentKey=&quot;id&quot;&gt;&lt;/childTable&gt;</span></span><br><span class="line"><span class="comment">	&lt;/table&gt;--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;table name=&quot;oc_call&quot; primaryKey=&quot;ID&quot; dataNode=&quot;dn1$0-743&quot; rule=&quot;latest-month-calldate&quot;</span></span><br><span class="line"><span class="comment">                        /&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;dataNode name=&quot;dn1$0-743&quot; dataHost=&quot;localhost1&quot; database=&quot;db$0-743&quot;</span></span><br><span class="line"><span class="comment">                /&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;mytest&quot;</span> /&gt;</span><span class="comment">&lt;!--填写对应的数据库/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;dataNode name=&quot;dn4&quot; dataHost=&quot;sequoiadb1&quot; database=&quot;SAMPLE&quot; /&gt;&lt;dataNode name=&quot;jdbc_dn1&quot; dataHost=&quot;jdbchost&quot; database=&quot;db1&quot; /&gt;&lt;dataNode       name=&quot;jdbc_dn2&quot; dataHost=&quot;jdbchost&quot; database=&quot;db2&quot; /&gt;&lt;dataNode name=&quot;jdbc_dn3&quot;       dataHost=&quot;jdbchost&quot; database=&quot;db3&quot; /&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">                          <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- can have multi write hosts --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;192.168.25.129&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.25.129:3306/mytest&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;192.168.1.6&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.1.6:3306/mytest&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;192.168.1.6&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.1.6:3306/mytest&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;writeHost host=&quot;hostM2&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot; password=&quot;123456&quot;/&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>schema指的是逻辑库和逻辑表，dataNode指的是数据节点，dataHost指的是物理数据库信息。writeHost填写自己部署的写服务器地址readHost填写读服务器地址</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;192.168.1.6&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.1.6:3306/mytest&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>这句当写服务器挂了后，可以把其他服务器或者自己的读服务器变为主服务器</strong>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">                          <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">maxCon，minCon可以规定连接数。</span><br><span class="line">balance:&quot;0&quot;:不开启读写分离</span><br><span class="line">		&quot;1&quot;:全部的readHost和stand by writeHost(等待的写服务器)参与select语句的负载</span><br><span class="line">		&quot;2&quot;:所有的读操作随机在readHost和writeHost分发</span><br><span class="line">		&quot;3&quot;:所有读请求随机分发到writeHost对应的readHost上执行</span><br><span class="line">writeType=&quot;0&quot;:所有的写操作发送到配置的第一个writeHost,第一个挂掉切换到还生存的第二个writeHost</span><br><span class="line">switchType:&quot;-1&quot;；不自动切换</span><br><span class="line">			&quot;1&quot;:自动切换，根据心跳select user()</span><br><span class="line">			&quot;2&quot;:基于MySQL的主从同步状态决定是否进行切换 show slave status来检测</span><br></pre></td></tr></table></figure>

<p><strong>启动出错可以去看wrapper.log</strong></p>
<p><strong>运行出错可以去看mycat.log</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#使用客户端连接</span><br><span class="line">mysql -h ip -P 8066 -u root -p 登录端口为9066是管理端口（监控和管理端口），8066是数据服务端口（SQL 端口）</span><br><span class="line">#默认用户名是 root，密码为你在 conf/server.xml 中 &lt;user&gt; 配置的密码。</span><br></pre></td></tr></table></figure>

<p><strong>如果确认是哪个服务器的数据库执行查，执行写，我们可以看对应数据库查询日志</strong></p>
<h2 id="MySQL分库分表"><a href="#MySQL分库分表" class="headerlink" title="MySQL分库分表"></a>MySQL分库分表</h2><p><strong>刚开始多数项目用单机数据库就够了，随着服务器流量越来越大，面对的请求也越来越多，我们做了数据库读写分离，使用多个从库副本（Slave）负责读，使用主库（Master）负责写，master和slave通过主从复制实现数据同步更新，保持数据一致。slave从库可以水平扩展，所以更多的读请求不成问题。</strong></p>
<p><strong>但是当用户量级上升，写请求越来越多，怎么保证数据库的负载足够？增加一个Master是不能解决问题的，因为数据要保持一致性，写操作需要2个master同步，相当于重复了，而且架构设计更加复杂。</strong></p>
<p><strong>这时需要用到分库分表(sharding)，对写操作进行切分。</strong></p>
<h3 id="库表问题"><a href="#库表问题" class="headerlink" title="库表问题"></a>库表问题</h3><p><strong>单库太大</strong></p>
<p><strong>单库处理能力有限，所在服务器上的磁盘空间不足，遇到IO瓶颈，需要将单库切分为更多更小的库。</strong></p>
<p><strong>单表太大</strong></p>
<p><strong>CRUD效率都很低，数据量太大导致索引膨胀，查询超时，需要把单表切分成多个数据集更小的表。</strong></p>
<h3 id="拆分策略"><a href="#拆分策略" class="headerlink" title="拆分策略"></a>拆分策略</h3><p><strong>单个库太大，先考虑是表多还是数据多：</strong></p>
<ol>
<li><strong>如果因为表多而造成数据过多，则使用垂直拆分，即根据业务拆分成不同的库</strong></li>
<li><strong>如果因为单张表的数据量太大，则使用水平拆分，即把表的数据按照某种规则拆分成多张表。</strong></li>
</ol>
<p><strong>分库分表的原则应先考虑垂直拆分，再考虑水平拆分。</strong></p>
<h3 id="垂直拆分"><a href="#垂直拆分" class="headerlink" title="垂直拆分"></a>垂直拆分</h3><p><strong>MyCat 垂直分库&#x3D;不同表走不同数据库，但对外仍是一个逻辑库，既解耦又统一</strong></p>
<h3 id="水平分表"><a href="#水平分表" class="headerlink" title="水平分表"></a>水平分表</h3><p><strong>水平分表&#x3D;将一张表“拆行”为多张表，用路由规则将数据映射到对应表，是应对大表性能瓶颈的核心手段。</strong></p>
<p><strong>后续mycat考虑深入</strong></p>
<h2 id="完结散花"><a href="#完结散花" class="headerlink" title="完结散花"></a>完结散花</h2></article>
<div class="article-footer">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    


    <section id="share">
      <div class="header"><span>分享文章</span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="http://yustonerain.top/MYSQLlearning/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg" /></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=http://yustonerain.top/MYSQLlearning/&title=MYSQLlearning - YuStone&summary=MySQL学习"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg" /></a><a class="social share-item email" href="mailto:?subject=MYSQLlearning - YuStone&amp;body=http://yustonerain.top/MYSQLlearning/"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg" /></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;复制成功&quot;)"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
        <div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=http://yustonerain.top/MYSQLlearning/"/>
        </div>
        
      </div>
    </section>
    </div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/C-basiclearning/">C++basiclearning</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">Linux网络编程</a></div></section></div>

<div class="related-wrap" id="related-posts"></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body utterances'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="utterances" repo="YuStone0416/YuStone0416.github.io" issue-term="pathname" theme="preferred-color-scheme"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p>本站由 <a href="/">YuStone</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1">Stellar 1.33.1</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E5%9F%BA%E7%A1%80"><span class="toc-text">MySQL基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E4%BB%8B%E7%BB%8D"><span class="toc-text">MySQL介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">MySQL数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E7%B1%BB%E5%9E%8B%EF%BC%88Integer-Types%EF%BC%89"><span class="toc-text">整数类型（Integer Types）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%AE%E7%82%B9%E4%B8%8E%E5%AE%9A%E7%82%B9%E7%B1%BB%E5%9E%8B%EF%BC%88Floating-Point-and-Fixed-Point-Types%EF%BC%89"><span class="toc-text">浮点与定点类型（Floating-Point and Fixed-Point Types）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E5%9E%8B%E7%B1%BB%E5%9E%8B"><span class="toc-text">字符型类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B"><span class="toc-text">日期和时间类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E4%B8%8E%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B%EF%BC%88%E5%8F%AF%E5%AD%98%E5%82%A8%E9%A2%84%E5%AE%9A%E4%B9%89%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%89"><span class="toc-text">枚举与集合类型（可存储预定义字符串）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">MySQL运算符</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%95%B0%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">算数运算符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">逻辑运算符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">比较运算符</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-text">MySQL常用函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E5%AE%8C%E6%95%B4%E6%80%A7%E7%BA%A6%E6%9D%9F"><span class="toc-text">MySQL完整性约束</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E7%BA%A6%E6%9D%9F"><span class="toc-text">主键约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%A2%9E%E9%94%AE%E7%BA%A6%E6%9D%9F"><span class="toc-text">自增键约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%94%AF%E4%B8%80%E9%94%AE%E7%BA%A6%E6%9D%9F"><span class="toc-text">唯一键约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E7%A9%BA%E7%BA%A6%E6%9D%9F"><span class="toc-text">非空约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%80%BC%E7%BA%A6%E6%9D%9F"><span class="toc-text">默认值约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F"><span class="toc-text">外键约束</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="toc-text">关系型数据库表设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80%E5%85%B3%E7%B3%BB"><span class="toc-text">一对一关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-text">一对多</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="toc-text">多对多</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E8%8C%83%E5%BC%8F"><span class="toc-text">关系型数据库范式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8C%83%E5%BC%8F%EF%BC%881NF%EF%BC%89"><span class="toc-text">第一范式（1NF）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8C%83%E5%BC%8F%EF%BC%882NF%EF%BC%89"><span class="toc-text">第二范式（2NF）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%8C%83%E5%BC%8F%EF%BC%883NF%EF%BC%89"><span class="toc-text">第三范式（3NF）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BC%E8%8C%83%E5%BC%8F%EF%BC%88BCNF%EF%BC%89"><span class="toc-text">BC范式（BCNF）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E8%8C%83%E5%BC%8F%EF%BC%884NF%EF%BC%89"><span class="toc-text">第四范式（4NF）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E6%A0%B8%E5%BF%83SQL"><span class="toc-text">MySQL核心SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5SQL"><span class="toc-text">结构化查询语句SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-text">库操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="toc-text">表操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CRUD%E6%93%8D%E4%BD%9C"><span class="toc-text">CRUD操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#insert%E5%A2%9E%E5%8A%A0"><span class="toc-text">insert增加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#update%E4%BF%AE%E6%94%B9"><span class="toc-text">update修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#delete%E5%88%A0%E9%99%A4"><span class="toc-text">delete删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select%E6%9F%A5%E8%AF%A2"><span class="toc-text">select查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2"><span class="toc-text">连接查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2"><span class="toc-text">内连接查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%96%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2"><span class="toc-text">外连接查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">MySQL存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%8C%BA%E5%88%AB"><span class="toc-text">各存储引擎区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%AF%B9%E6%AF%94"><span class="toc-text">MySQL 存储引擎对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E7%B4%A2%E5%BC%95"><span class="toc-text">MySQL索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="toc-text">索引分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%9B%E5%BB%BA%E5%92%8C%E5%88%A0%E9%99%A4"><span class="toc-text">索引创建和删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-text">索引的执行过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#explain%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-text">explain查看执行计划</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">索引的底层实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#InnoDB%E7%9A%84%E4%B8%BB%E9%94%AE%E5%92%8C%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E6%A0%91"><span class="toc-text">InnoDB的主键和二级索引树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyISAM%E7%9A%84%E4%B8%BB%E9%94%AE%E5%92%8C%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E6%A0%91"><span class="toc-text">MyISAM的主键和二级索引树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E7%B4%A2%E5%BC%95"><span class="toc-text">哈希索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InnoDB%E8%87%AA%E9%80%82%E5%BA%94%E5%93%88%E5%B8%8C%E7%B4%A2%E5%BC%95"><span class="toc-text">InnoDB自适应哈希索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text">慢查询日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E4%BA%8B%E5%8A%A1"><span class="toc-text">MySQL事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%A6%82%E5%BF%B5"><span class="toc-text">事务概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACID%E7%89%B9%E6%80%A7"><span class="toc-text">ACID特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%B9%B6%E5%8F%91%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">事务并发存在的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-text">事务的隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E7%9A%84%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E5%91%BD%E4%BB%A4"><span class="toc-text">MySQL的事务处理命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E7%9A%84%E9%94%81%E6%9C%BA%E5%88%B6"><span class="toc-text">MySQL的锁机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E7%BA%A7%E9%94%81-%E8%A1%8C%E7%BA%A7%E9%94%81"><span class="toc-text">表级锁&amp;行级锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E5%AE%83%E9%94%81%E5%92%8C%E5%85%B1%E4%BA%AB%E9%94%81"><span class="toc-text">排它锁和共享锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB%E8%A1%8C%E7%BA%A7%E9%94%81"><span class="toc-text">InnoDB行级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%8C%E7%BA%A7%E9%94%81"><span class="toc-text">行级锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81-gap-lock"><span class="toc-text">间隙锁(gap lock)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB%E8%A1%A8%E7%BA%A7%E9%94%81"><span class="toc-text">InnoDB表级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%84%8F%E5%90%91%E5%85%B1%E4%BA%AB%E9%94%81%E5%92%8C%E6%84%8F%E5%90%91%E6%8E%92%E4%BB%96%E9%94%81"><span class="toc-text">意向共享锁和意向排他锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-text">死锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E7%9A%84%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="toc-text">锁的优化建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redo-log%E5%92%8Cundo-log"><span class="toc-text">redo log和undo log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MVCC%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-text">MVCC多版本并发控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E4%BC%98%E5%8C%96"><span class="toc-text">MySQL优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E6%97%A5%E5%BF%97"><span class="toc-text">MySQL日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97"><span class="toc-text">二进制日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E8%AF%A6%E7%BB%86%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">SQL详细处理流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E9%9B%86%E7%BE%A4"><span class="toc-text">MySQL集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">主从复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE"><span class="toc-text">mysql主从复制配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-text">读写分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mycat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E9%85%8D%E7%BD%AE"><span class="toc-text">Mycat读写分离配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-text">MySQL分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E8%A1%A8%E9%97%AE%E9%A2%98"><span class="toc-text">库表问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%86%E5%88%86%E7%AD%96%E7%95%A5"><span class="toc-text">拆分策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86"><span class="toc-text">垂直拆分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8"><span class="toc-text">水平分表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E7%BB%93%E6%95%A3%E8%8A%B1"><span class="toc-text">完结散花</span></a></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M8 10.5h8M8 14h5.5M17 3.338A9.95 9.95 0 0 0 12 2C6.477 2 2 6.477 2 12c0 1.6.376 3.112 1.043 4.453c.178.356.237.763.134 1.148l-.595 2.226a1.3 1.3 0 0 0 1.591 1.592l2.226-.596a1.63 1.63 0 0 1 1.149.133A9.96 9.96 0 0 0 12 22c5.523 0 10-4.477 10-10c0-1.821-.487-3.53-1.338-5"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":null,"officialHosts":["localhost"],"encoded":""};
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] 超时:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('请求超时');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('响应失败');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] 错误:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // 通知 LazyLoad 更新
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: 这会导致无法使用 preferred_color_scheme 以外的主题
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector("#comments #utterances");
  util.viewportLazyload(el, load_utterances, false);

  function load_utterances() {
    if (!el) return;
    try {
      el.innerHTML = '';
    } catch (error) {
      console.error(error);
    }
    const script = document.createElement('script');
    script.src = 'https://utteranc.es/client.js';
    script.async = true;
    for (const key of Object.keys(el.attributes)) {
      const attr = el.attributes[key];
      if (['class', 'id'].includes(attr.name) === false) {
        script.setAttribute(attr.name, attr.value);
      }
    }
    el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
